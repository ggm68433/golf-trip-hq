This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  api/
    invite/
      route.ts
  auth/
    auth-code-error/
      page.tsx
    callback/
      route.ts
    signout/
      route.ts
  dashboard/
    page.tsx
  trip/
    components/
      TripDining.tsx
      TripExpenses.tsx
      TripFlights.tsx
      TripGolf.tsx
      TripLodging.tsx
      TripRoster.tsx
    page.tsx
    types.ts
  favicon.ico
  globals.css
  layout.tsx
  page.tsx
components/
  ExpenseTracker.tsx
  FlightDashboard.tsx
  OnboardingModal.tsx
  WeatherWidget.tsx
public/
  file.svg
  globe.svg
  next.svg
  vercel.svg
  window.svg
utils/
  supabase/
    serverClient.ts
  format.ts
.firebaserc
.gitignore
eslint.config.mjs
firebase.json
middleware.ts
next.config.ts
package.json
postcss.config.mjs
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/auth/auth-code-error/page.tsx">
'use client'

import Link from 'next/link'

export default function AuthErrorPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-[#f9fbf9] p-4">
      <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center border border-slate-100">
        <div className="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6">
          <span className="material-symbols-outlined text-red-500 text-3xl">error_outline</span>
        </div>
        <h1 className="text-2xl font-bold text-slate-900 mb-2">Login Failed</h1>
        <p className="text-slate-500 mb-8">
          We couldn't verify your login link. It may have expired or been used already.
        </p>
        <Link 
          href="/" 
          className="inline-flex items-center justify-center w-full py-3 px-4 bg-[#1a4d2e] text-white font-bold rounded-xl hover:bg-[#0d2818] transition-colors"
        >
          Return Home
        </Link>
      </div>
    </div>
  )
}
</file>

<file path="app/auth/callback/route.ts">
import { cookies } from 'next/headers'
import { NextResponse } from 'next/server'
import { type CookieOptions, createServerClient } from '@supabase/ssr'

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  // The 'next' param allows us to redirect to a specific page (like /dashboard) after login
  const next = searchParams.get('next') ?? '/dashboard'

  if (code) {
    const cookieStore = await cookies()
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          get(name: string) {
            return cookieStore.get(name)?.value
          },
          set(name: string, value: string, options: CookieOptions) {
            cookieStore.set({ name, value, ...options })
          },
          remove(name: string, options: CookieOptions) {
            cookieStore.delete({ name, ...options })
          },
        },
      }
    )
    
    // This exchanges the secure code for a session cookie
    const { error } = await supabase.auth.exchangeCodeForSession(code)
    
    if (!error) {
      return NextResponse.redirect(`${origin}${next}`)
    }
  }

  // If something breaks, send them to an error page
  return NextResponse.redirect(`${origin}/auth/auth-code-error`)
}
</file>

<file path="app/auth/signout/route.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { NextResponse } from 'next/server'

export async function POST(request: Request) {
  const cookieStore = await cookies()

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          cookieStore.set({ name, value, ...options })
        },
        remove(name: string, options: CookieOptions) {
          // This forces the cookie to expire immediately
          cookieStore.set({ name, value: '', ...options, maxAge: 0 })
        },
      },
    }
  )

  // 1. Sign out on the server
  await supabase.auth.signOut()

  // 2. Force redirect to home page
  return NextResponse.redirect(new URL('/', request.url), {
    status: 302,
  })
}
</file>

<file path="app/trip/components/TripDining.tsx">
'use client'

import { useState } from 'react'
import { createBrowserClient } from '@supabase/ssr'
import DatePicker from 'react-datepicker'
import "react-datepicker/dist/react-datepicker.css"
import { Dining } from '../types'

const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

export default function TripDining({ 
  tripId, 
  dinings, 
  onUpdate 
}: { 
  tripId: string, 
  dinings: Dining[], 
  onUpdate: () => void 
}) {
  // --- STATE ---
  const [showModal, setShowModal] = useState(false)
  const [editingId, setEditingId] = useState<string | null>(null)

  // Form State
  const [name, setName] = useState('')
  const [address, setAddress] = useState('')
  const [city, setCity] = useState('')
  const [state, setState] = useState('')
  const [zip, setZip] = useState('')
  const [url, setUrl] = useState('')
  const [date, setDate] = useState<Date | null>(null)
  const [time, setTime] = useState('19:00')
  const [partySize, setPartySize] = useState('')

  // --- STATS ---
  const totalReservations = dinings.length

  // --- HANDLERS ---
  const handleOpenModal = (dining?: Dining) => {
    if (dining) {
      setEditingId(dining.id)
      setName(dining.name)
      setAddress(dining.street_address)
      setCity(dining.city || '')
      setState(dining.state || '')
      setZip(dining.zip_code || '')
      setUrl(dining.website_url || '')
      setPartySize(dining.party_size.toString())
      
      // FIX: Manually parse string to avoid Timezone Shift
      // DB Format: "2026-02-12T20:00:00+00:00"
      if (dining.reservation_time) {
        const [rawDate, rawTime] = dining.reservation_time.split('T')
        const [y, m, d] = rawDate.split('-').map(Number)
        
        // Create date as Local Noon to avoid rollover issues
        setDate(new Date(y, m - 1, d, 12, 0, 0))
        
        // Extract "20:00" directly from string
        setTime(rawTime.slice(0, 5))
      }
    } else {
      setEditingId(null)
      setName(''); setAddress(''); setCity(''); setState(''); setZip(''); setUrl(''); setPartySize('')
      setDate(null); setTime('19:00')
    }
    setShowModal(true)
  }

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!name || !date || !tripId) return

    // Create "YYYY-MM-DD" in local time
    const dateStr = date.toLocaleDateString('en-CA')
    const fullTimestamp = `${dateStr}T${time}:00`

    const payload = {
      trip_id: tripId,
      name: name,
      street_address: address,
      city: city,
      state: state,
      zip_code: zip,
      website_url: url,
      reservation_time: fullTimestamp,
      party_size: partySize ? parseInt(partySize) : 0
    }

    let result
    if (editingId) {
      result = await supabase.from('trip_dining').update(payload).eq('id', editingId).select()
    } else {
      result = await supabase.from('trip_dining').insert(payload).select()
    }

    const { error } = result

    if (error) {
      console.error("Save failed:", error.message)
      alert(`Failed to save: ${error.message}`)
    } else {
      setShowModal(false)
      onUpdate()
    }
  }

  const handleDelete = async (id: string) => {
    if (!confirm('Remove this reservation?')) return
    await supabase.from('trip_dining').delete().eq('id', id)
    onUpdate()
  }

  // --- HELPER: TIMEZONE-SAFE FORMATTER ---
  const formatDateTime = (iso: string) => {
    if (!iso) return { date: '—', time: '—' }

    // Split "2026-02-12T20:00:00" directly
    const [datePart, timePart] = iso.split('T')
    if (!datePart || !timePart) return { date: '—', time: '—' }

    const [y, m, d] = datePart.split('-').map(Number)
    const [h, min] = timePart.split(':').map(Number)

    // Create a generic Date object using the exact numbers we see
    // This tricks the browser into displaying exactly what we stored
    const localDate = new Date(y, m - 1, d, h, min)

    return {
      date: localDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      time: localDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
    }
  }

  const buildAddressQuery = (street: string, city?: string, state?: string, zip?: string) => {
    const parts = [street, city, state, zip].filter(Boolean)
    return encodeURIComponent(parts.join(', '))
  }

  return (
    <div className="p-8 max-w-5xl mx-auto pb-20">
      
      {/* HEADER */}
      <div className="mb-8">
        <h2 className="text-2xl font-bold text-slate-900 tracking-tight">Dining Reservations</h2>
        <p className="text-sm text-slate-500 mt-1">Manage restaurant bookings and group meals.</p>
      </div>

      {/* STATS (Single Card) */}
      <div className="mb-8">
        <div className="bg-white rounded-xl border border-slate-200 p-5 shadow-sm flex items-center space-x-4 max-w-md">
          <div className="w-12 h-12 rounded-lg bg-[#1a4d2e]/10 flex items-center justify-center text-[#1a4d2e]">
            <span className="material-symbols-outlined text-2xl">restaurant</span>
          </div>
          <div>
            <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Reservations</p>
            <p className="text-2xl font-bold text-slate-900">{totalReservations}</p>
          </div>
        </div>
      </div>

      {/* LIST */}
      <div className="flex flex-col gap-6">
        {dinings.map((dining) => (
          <div key={dining.id} className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden group hover:border-[#1a4d2e]/50 transition-all hover:shadow-md">
            <div className="h-1.5 bg-[#1a4d2e]"></div>
            <div className="p-6">
              
              {/* Top Row: Name & Actions */}
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                  <h2 className="text-2xl font-bold text-[#1a4d2e]">{dining.name}</h2>
                  
                  {/* Address Line */}
                  <div className="flex items-center text-slate-500 text-sm mt-1">
                    <span className="material-symbols-outlined text-lg mr-1 text-[#d4af37]">place</span>
                    <span>{dining.street_address}{dining.city ? `, ${dining.city}` : ''}</span>
                    <a 
                      href={`https://www.google.com/maps/search/?api=1&query=$${buildAddressQuery(dining.street_address, dining.city, dining.state, dining.zip_code)}`} 
                      target="_blank" rel="noopener noreferrer"
                      className="ml-3 text-[#1a4d2e] hover:underline text-xs font-semibold flex items-center transition-colors"
                    >
                      View on Map <span className="material-symbols-outlined text-sm ml-0.5">open_in_new</span>
                    </a>
                  </div>

                  {/* Website Line */}
                  {dining.website_url && (
                    <div className="mt-1 flex items-center text-xs">
                      <a href={dining.website_url.startsWith('http') ? dining.website_url : `https://${dining.website_url}`} target="_blank" rel="noopener noreferrer" className="flex items-center text-slate-400 hover:text-[#1a4d2e] transition-colors">
                        <span className="material-symbols-outlined text-sm mr-1">link</span>
                        {dining.website_url.replace(/^https?:\/\//, '')}
                      </a>
                    </div>
                  )}
                </div>

                {/* Actions (Visible on Hover) */}
                <div className="flex space-x-2 mt-4 md:mt-0 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button onClick={() => handleOpenModal(dining)} className="p-2 text-slate-400 hover:text-[#1a4d2e] transition-colors bg-slate-50 hover:bg-slate-100 rounded-lg" title="Edit"><span className="material-symbols-outlined">edit</span></button>
                  <button onClick={() => handleDelete(dining.id)} className="p-2 text-slate-400 hover:text-red-500 transition-colors bg-slate-50 hover:bg-red-50 rounded-lg" title="Delete"><span className="material-symbols-outlined">delete</span></button>
                </div>
              </div>
              
              {/* Bottom Row: Date/Time Grid */}
              <div className="border-t border-slate-100 pt-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  {/* Reservation Time */}
                  <div className="flex items-center bg-slate-50 rounded-lg p-4 border border-slate-100">
                    <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-[#1a4d2e] border border-slate-200 mr-4 shadow-sm">
                      <span className="material-symbols-outlined text-xl">event</span>
                    </div>
                    <div>
                      <p className="text-xs font-bold text-slate-400 uppercase mb-0.5">Reservation</p>
                      <div className="font-semibold text-slate-800 text-base">
                        {formatDateTime(dining.reservation_time).date} <span className="text-slate-400 font-normal mx-1">at</span> {formatDateTime(dining.reservation_time).time}
                      </div>
                    </div>
                  </div>

                  {/* Party Size */}
                  <div className="flex items-center bg-slate-50 rounded-lg p-4 border border-slate-100">
                    <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-[#d4af37] border border-slate-200 mr-4 shadow-sm">
                      <span className="material-symbols-outlined text-xl">groups</span>
                    </div>
                    <div>
                      <p className="text-xs font-bold text-slate-400 uppercase mb-0.5">Party Size</p>
                      <div className="font-semibold text-slate-800 text-base">
                        {dining.party_size} <span className="text-slate-400 font-normal">Guests</span>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        ))}

        {/* SHADOW CARD (Add Reservation) */}
        <button 
          onClick={() => handleOpenModal()} 
          className="border-2 border-dashed border-slate-300 rounded-xl p-8 flex flex-col items-center justify-center text-center bg-slate-50/50 hover:bg-slate-50 hover:border-[#1a4d2e] transition-all cursor-pointer group w-full min-h-[160px]"
        >
          <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4 group-hover:scale-110 transition-transform duration-300 border border-slate-200 text-slate-400 group-hover:text-[#1a4d2e]">
            <span className="material-symbols-outlined text-3xl">add</span>
          </div>
          <h3 className="text-lg font-bold text-slate-500 group-hover:text-[#1a4d2e] transition-colors">Add Reservation</h3>
          <p className="text-slate-400 text-sm mt-1">Book dinners, lunches, or events</p>
        </button>

      </div>

      {/* MODAL */}
      {showModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm" onClick={() => setShowModal(false)}>
          <div className="relative w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden animate-[fadeInUp_0.2s_ease-out]" onClick={e => e.stopPropagation()}>
            
            <div className="p-6 border-b border-gray-100 flex items-center gap-3">
              <span className="material-symbols-outlined text-[#1a4d2e]">restaurant</span>
              <h3 className="text-xl font-bold text-[#0d2818]">{editingId ? 'Edit Reservation' : 'Add Reservation'}</h3>
            </div>
            
            <div className="p-6">
              <form onSubmit={handleSave} className="flex flex-col gap-5">
                <div className="flex flex-col gap-2">
                  <label className="text-xs font-bold uppercase text-gray-500">Restaurant Name</label>
                  <input value={name} onChange={e => setName(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="e.g. Steakhouse 44" required />
                </div>

                <div className="grid grid-cols-12 gap-3">
                   <div className="col-span-5 flex flex-col gap-2">
                      <label className="text-xs font-bold uppercase text-gray-500">Date</label>
                      <div className="border border-gray-200 rounded-lg p-1 bg-white focus-within:ring-2 focus-within:ring-[#1a4d2e]"><DatePicker selected={date} onChange={(d: Date | null) => setDate(d)} className="w-full p-2 outline-none" placeholderText="Select" required /></div>
                   </div>
                   <div className="col-span-4 flex flex-col gap-2">
                      <label className="text-xs font-bold uppercase text-gray-500">Time</label>
                      <input type="time" value={time} onChange={e => setTime(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" required />
                   </div>
                   <div className="col-span-3 flex flex-col gap-2">
                      <label className="text-xs font-bold uppercase text-gray-500">Guests</label>
                      <input type="number" value={partySize} onChange={e => setPartySize(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="4" required />
                   </div>
                </div>

                <div className="flex flex-col gap-2">
                  <label className="text-xs font-bold uppercase text-gray-500">Street Address</label>
                  <input value={address} onChange={e => setAddress(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="123 Main St" required />
                </div>

                <div className="grid grid-cols-12 gap-3">
                   <div className="col-span-6 flex flex-col gap-2">
                      <label className="text-xs font-bold uppercase text-gray-500">City</label>
                      <input value={city} onChange={e => setCity(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="City" required />
                   </div>
                   <div className="col-span-3 flex flex-col gap-2">
                      <label className="text-xs font-bold uppercase text-gray-500">State</label>
                      <input value={state} onChange={e => setState(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="ST" required />
                   </div>
                   <div className="col-span-3 flex flex-col gap-2">
                      <label className="text-xs font-bold uppercase text-gray-500">Zip</label>
                      <input value={zip} onChange={e => setZip(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="Zip" required />
                   </div>
                </div>

                <div className="flex flex-col gap-2">
                   <label className="text-xs font-bold uppercase text-gray-500">Website URL <span className="font-normal normal-case italic text-gray-400">(Optional)</span></label>
                   <input type="url" value={url} onChange={e => setUrl(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="https://..." />
                </div>

                <div className="flex gap-2 mt-4 pt-4 border-t border-gray-100">
                  <button type="button" onClick={() => setShowModal(false)} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-lg">Cancel</button>
                  <button type="submit" className="flex-1 py-3 bg-[#1a4d2e] text-white font-bold rounded-lg hover:bg-[#143a22]">Save Reservation</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

    </div>
  )
}
</file>

<file path="app/trip/components/TripExpenses.tsx">
'use client'

import { useState, useEffect } from 'react'
import { createBrowserClient } from '@supabase/ssr'
import DatePicker from 'react-datepicker'
import "react-datepicker/dist/react-datepicker.css"
import { Expense, Golfer } from '../types'

const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

// Helper to calculate debts
type Debt = {
  from: string;
  to: string;
  amount: number;
}

export default function TripExpenses({ 
  tripId, 
  expenses, 
  golfers,
  onUpdate 
}: { 
  tripId: string, 
  expenses: Expense[], 
  golfers: Golfer[],
  onUpdate: () => void 
}) {
  // --- STATE ---
  const [view, setView] = useState<'ledger' | 'balances'>('ledger')
  const [showModal, setShowModal] = useState(false)
  const [editingId, setEditingId] = useState<string | null>(null)

  // Form State
  const [description, setDescription] = useState('')
  const [amount, setAmount] = useState('')
  const [payerId, setPayerId] = useState('')
  const [date, setDate] = useState<Date | null>(new Date())
  const [splitMethod, setSplitMethod] = useState<'equal' | 'custom'>('equal')
  const [selectedGolferIds, setSelectedGolferIds] = useState<string[]>([])

  // --- EFFECT: Set Default Payer ---
  useEffect(() => {
    if (golfers.length > 0 && !payerId) {
      setPayerId(golfers[0].id)
    }
  }, [golfers, payerId])

  // --- CALCULATE BALANCES ---
  const calculateBalances = () => {
    // 1. Net Balance per person (positive = owed money, negative = owes money)
    const balances: Record<string, number> = {}
    golfers.forEach(g => balances[g.id] = 0)

    expenses.forEach(expense => {
      // Add amount to payer
      balances[expense.payer_id] = (balances[expense.payer_id] || 0) + expense.amount

      // Subtract from splitters
      const splitters = expense.split_method === 'custom' && expense.split_among 
        ? expense.split_among 
        : golfers.map(g => g.id)
      
      const splitAmount = expense.amount / (splitters.length || 1)
      
      splitters.forEach(id => {
        balances[id] = (balances[id] || 0) - splitAmount
      })
    })

    // 2. Simplify Debts
    const debts: Debt[] = []
    const debtors = Object.entries(balances).filter(([, bal]) => bal < -0.01).sort((a, b) => a[1] - b[1]) // Most negative first
    const creditors = Object.entries(balances).filter(([, bal]) => bal > 0.01).sort((a, b) => b[1] - a[1]) // Most positive first

    let i = 0; let j = 0;
    while (i < debtors.length && j < creditors.length) {
      const [debtorId, debtorBal] = debtors[i]
      const [creditorId, creditorBal] = creditors[j]
      
      const amount = Math.min(Math.abs(debtorBal), creditorBal)
      debts.push({ from: debtorId, to: creditorId, amount })

      // Update remaining
      debtors[i][1] += amount
      creditors[j][1] -= amount

      if (Math.abs(debtors[i][1]) < 0.01) i++
      if (Math.abs(creditors[j][1]) < 0.01) j++
    }

    return debts
  }

  const debts = calculateBalances()

  // --- HANDLERS ---
  const handleOpenModal = (expense?: Expense) => {
    if (expense) {
      setEditingId(expense.id)
      setDescription(expense.description)
      setAmount(expense.amount.toString())
      setPayerId(expense.payer_id)
      setSplitMethod((expense.split_method as 'equal' | 'custom') || 'equal')
      
      if (expense.expense_date) {
        const [y, m, d] = expense.expense_date.split('-').map(Number)
        setDate(new Date(y, m - 1, d, 12, 0, 0))
      }
      
      if (expense.split_among && expense.split_among.length > 0) {
        setSelectedGolferIds(expense.split_among)
      } else {
        setSelectedGolferIds(golfers.map(g => g.id))
      }
    } else {
      setEditingId(null)
      setDescription('')
      setAmount('')
      setPayerId(golfers[0]?.id || '')
      setSplitMethod('equal')
      setDate(new Date())
      setSelectedGolferIds(golfers.map(g => g.id))
    }
    setShowModal(true)
  }

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault()
    
    if (!tripId || !description || !amount || !date || !payerId) return alert("Please fill in all required fields.")

    const dateStr = date.toLocaleDateString('en-CA')

    const payload = {
      trip_id: tripId,
      description: description,
      amount: parseFloat(amount),
      payer_id: payerId,
      expense_date: dateStr,
      split_method: splitMethod,
      split_among: splitMethod === 'custom' ? selectedGolferIds : null
    }

    let result
    if (editingId) {
      result = await supabase.from('trip_expenses').update(payload).eq('id', editingId).select()
    } else {
      result = await supabase.from('trip_expenses').insert(payload).select()
    }

    const { data, error } = result

    if (error) {
      console.error("Supabase Error:", error)
      alert(`Save Failed: ${error.message}`)
    } else if (!data || data.length === 0) {
      alert("Save Failed: Database permission denied (RLS).")
    } else {
      setShowModal(false)
      onUpdate()
    }
  }

  const handleDelete = async (id: string) => {
    if (!confirm('Delete this expense?')) return
    await supabase.from('trip_expenses').delete().eq('id', id)
    onUpdate()
  }

  const toggleGolferSelection = (id: string) => {
    if (selectedGolferIds.includes(id)) {
      setSelectedGolferIds(selectedGolferIds.filter(g => g !== id))
    } else {
      setSelectedGolferIds([...selectedGolferIds, id])
    }
  }

  // --- HELPERS ---
  const getGolferName = (id: string) => golfers.find(g => g.id === id)?.name || 'Unknown'
  const getInitials = (name: string) => name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
  
  const formatDate = (iso: string) => {
    if (!iso) return '—'
    const [y, m, d] = iso.split('-').map(Number)
    const localDate = new Date(y, m - 1, d, 12, 0, 0)
    return localDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
  }

  return (
    <div className="p-8 max-w-5xl mx-auto pb-20">
      
      {/* HEADER + TOGGLE */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
          <h2 className="text-2xl font-bold text-slate-900 tracking-tight">Trip Expenses</h2>
          <p className="text-sm text-slate-500 mt-1">Track shared costs and settle up.</p>
        </div>
        
        {/* VIEW TOGGLE */}
        <div className="flex bg-slate-200 p-1 rounded-lg">
          <button 
            onClick={() => setView('ledger')} 
            className={`px-6 py-2 text-sm font-bold rounded-md transition-all ${view === 'ledger' ? 'bg-white text-[#1a4d2e] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
          >
            Ledger
          </button>
          <button 
            onClick={() => setView('balances')} 
            className={`px-6 py-2 text-sm font-bold rounded-md transition-all ${view === 'balances' ? 'bg-white text-[#1a4d2e] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
          >
            Balances
          </button>
        </div>
      </div>

      {/* --- LEDGER VIEW --- */}
      {view === 'ledger' && (
        <div className="flex flex-col gap-4">
          {expenses.length === 0 ? (
            <div className="text-center py-12 bg-slate-50 rounded-xl border border-dashed border-slate-200">
              <p className="text-slate-400 font-medium">No expenses recorded yet.</p>
            </div>
          ) : (
            expenses.map((expense) => (
              <div key={expense.id} className="bg-white rounded-xl border border-slate-200 shadow-sm p-5 flex items-center justify-between group hover:border-[#1a4d2e]/50 transition-all hover:shadow-md">
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 border border-slate-100">
                    <span className="material-symbols-outlined">receipt_long</span>
                  </div>
                  <div>
                    <h3 className="text-lg font-bold text-slate-900 leading-tight">{expense.description}</h3>
                    <p className="text-sm text-slate-500 flex items-center gap-1 mt-0.5">
                      <span className="font-medium text-slate-700">Paid by {getGolferName(expense.payer_id)}</span>
                      <span className="w-1 h-1 rounded-full bg-slate-300"></span>
                      <span>{formatDate(expense.expense_date)}</span>
                    </p>
                  </div>
                </div>
                <div className="flex items-center gap-6">
                  <div className="text-right">
                    <p className="text-xl font-bold text-[#1a4d2e]">${expense.amount.toFixed(2)}</p>
                    <p className="text-xs text-slate-400 uppercase font-bold tracking-wide">{expense.split_method}</p>
                  </div>
                  <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onClick={() => handleOpenModal(expense)} className="p-2 text-slate-400 hover:text-[#1a4d2e] transition-colors bg-slate-50 hover:bg-slate-100 rounded-lg"><span className="material-symbols-outlined text-lg">edit</span></button>
                    <button onClick={() => handleDelete(expense.id)} className="p-2 text-slate-400 hover:text-red-500 transition-colors bg-slate-50 hover:bg-red-50 rounded-lg"><span className="material-symbols-outlined text-lg">delete</span></button>
                  </div>
                </div>
              </div>
            ))
          )}

          {/* SHADOW CARD (Add Expense) */}
          <button 
            onClick={() => handleOpenModal()} 
            className="border-2 border-dashed border-slate-300 rounded-xl p-8 flex flex-col items-center justify-center text-center bg-slate-50/50 hover:bg-slate-50 hover:border-[#1a4d2e] transition-all cursor-pointer group w-full min-h-[140px] mt-4"
          >
            <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-sm mb-3 group-hover:scale-110 transition-transform duration-300 border border-slate-200 text-slate-400 group-hover:text-[#1a4d2e]">
              <span className="material-symbols-outlined text-3xl">add</span>
            </div>
            <h3 className="text-lg font-bold text-slate-500 group-hover:text-[#1a4d2e] transition-colors">Add Expense</h3>
          </button>
        </div>
      )}

      {/* --- BALANCES VIEW --- */}
      {view === 'balances' && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {debts.length === 0 ? (
            <div className="col-span-full text-center py-12 bg-white rounded-xl border border-slate-200 shadow-sm">
              <div className="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                <span className="material-symbols-outlined text-3xl">check</span>
              </div>
              <h3 className="text-lg font-bold text-slate-900">All Settled Up!</h3>
              <p className="text-slate-500 mt-1">No debts found based on current expenses.</p>
            </div>
          ) : (
            debts.map((debt, i) => (
              <div key={i} className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center text-center relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-400 to-green-400"></div>
                
                {/* Avatar Pair */}
                <div className="flex items-center gap-4 mb-4 mt-2">
                  <div className="flex flex-col items-center">
                    <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500 border border-slate-200 mb-1">{getInitials(getGolferName(debt.from))}</div>
                    <span className="text-xs font-bold text-slate-900">{getGolferName(debt.from).split(' ')[0]}</span>
                  </div>
                  <div className="flex flex-col items-center text-slate-400">
                    <span className="text-[10px] font-bold uppercase tracking-wider mb-1">Pays</span>
                    <span className="material-symbols-outlined text-2xl">arrow_forward</span>
                  </div>
                  <div className="flex flex-col items-center">
                    <div className="w-12 h-12 rounded-full bg-[#1a4d2e] flex items-center justify-center text-xs font-bold text-white border border-[#1a4d2e] mb-1">{getInitials(getGolferName(debt.to))}</div>
                    <span className="text-xs font-bold text-slate-900">{getGolferName(debt.to).split(' ')[0]}</span>
                  </div>
                </div>

                <div className="bg-slate-50 rounded-full px-4 py-1 border border-slate-200">
                  <span className="text-xl font-bold text-slate-900">${debt.amount.toFixed(2)}</span>
                </div>
              </div>
            ))
          )}
        </div>
      )}

      {/* MODAL */}
      {showModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm" onClick={() => setShowModal(false)}>
          <div className="relative w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden animate-[fadeInUp_0.2s_ease-out]" onClick={e => e.stopPropagation()}>
            <div className="p-6 border-b border-gray-100 flex items-center gap-3"><span className="material-symbols-outlined text-[#1a4d2e]">payments</span><h3 className="text-xl font-bold text-[#0d2818]">{editingId ? 'Edit Expense' : 'Add Expense'}</h3></div>
            <div className="p-6 overflow-y-auto max-h-[80vh]">
              <form onSubmit={handleSave} className="flex flex-col gap-5">
                <div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Description</label><input value={description} onChange={e => setDescription(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="e.g. Airbnb Deposit" required /></div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Amount ($)</label><input type="number" step="0.01" value={amount} onChange={e => setAmount(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="0.00" required /></div>
                  <div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Date</label><div className="border border-gray-200 rounded-lg p-1 bg-white focus-within:ring-2 focus-within:ring-[#1a4d2e]"><DatePicker selected={date} onChange={(d: Date | null) => setDate(d)} className="w-full p-2 outline-none" placeholderText="Select Date" required /></div></div>
                </div>
                <div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Paid By</label><select value={payerId} onChange={e => setPayerId(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e] bg-white">{golfers.length === 0 && <option value="">No golfers found</option>}{golfers.map(g => (<option key={g.id} value={g.id}>{g.name}</option>))}</select></div>
                <div className="flex flex-col gap-3">
                  <label className="text-xs font-bold uppercase text-gray-500">Split Method</label>
                  <div className="flex bg-slate-100 p-1 rounded-lg">
                    <button type="button" onClick={() => setSplitMethod('equal')} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${splitMethod === 'equal' ? 'bg-white text-[#1a4d2e] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Split Equally</button>
                    <button type="button" onClick={() => setSplitMethod('custom')} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${splitMethod === 'custom' ? 'bg-white text-[#1a4d2e] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Select Golfers</button>
                  </div>
                </div>
                {splitMethod === 'custom' && (
                  <div className="flex flex-col gap-2 border border-slate-200 rounded-xl p-3 max-h-48 overflow-y-auto">
                    {golfers.map(g => (
                      <div key={g.id} onClick={() => toggleGolferSelection(g.id)} className={`flex items-center justify-between p-2 rounded-lg cursor-pointer transition-colors ${selectedGolferIds.includes(g.id) ? 'bg-[#1a4d2e]/10' : 'hover:bg-slate-50'}`}>
                        <div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${selectedGolferIds.includes(g.id) ? 'bg-[#1a4d2e] text-white' : 'bg-slate-200 text-slate-500'}`}>{getInitials(g.name)}</div><span className={`text-sm font-medium ${selectedGolferIds.includes(g.id) ? 'text-[#1a4d2e]' : 'text-slate-600'}`}>{g.name}</span></div>
                        {selectedGolferIds.includes(g.id) && <span className="material-symbols-outlined text-[#1a4d2e] text-lg">check_circle</span>}
                      </div>
                    ))}
                  </div>
                )}
                <div className="flex gap-2 mt-2 pt-4 border-t border-gray-100"><button type="button" onClick={() => setShowModal(false)} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-lg">Cancel</button><button type="submit" className="flex-1 py-3 bg-[#1a4d2e] text-white font-bold rounded-lg hover:bg-[#143a22]">Save Expense</button></div>
              </form>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
</file>

<file path="app/trip/components/TripFlights.tsx">
'use client'

import { useState, useEffect } from 'react'
import { createBrowserClient } from '@supabase/ssr'
import DatePicker from 'react-datepicker'
import "react-datepicker/dist/react-datepicker.css"
import { Golfer, Flight } from '../types'

const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

export default function TripFlights({ tripId, golfers, onUpdate }: { tripId: string, golfers: Golfer[], onUpdate: () => void }) {
  const [showModal, setShowModal] = useState(false)
  const [editingId, setEditingId] = useState<string | null>(null)
  
  // Local State
  const [localGolfers, setLocalGolfers] = useState<Golfer[]>(golfers)
  useEffect(() => { setLocalGolfers(golfers) }, [golfers])
  
  const [golferId, setGolferId] = useState('')
  const [legType, setLegType] = useState<'arrival' | 'departure'>('arrival')
  const [airline, setAirline] = useState('')
  const [flightNum, setFlightNum] = useState('')
  const [depAirport, setDepAirport] = useState('')
  const [arrAirport, setArrAirport] = useState('')
  const [flightDate, setFlightDate] = useState<Date | null>(null)
  const [depTime, setDepTime] = useState('')
  const [arrTime, setArrTime] = useState('')

  const todayStr = new Date().toISOString().split('T')[0]
  const arrivalsToday = localGolfers.filter(g => !g.is_driving && g.flights?.some(f => f.leg_type === 'arrival' && f.arrival_time && f.arrival_time.startsWith(todayStr))).length
  const confirmedGolfers = localGolfers.filter(g => g.is_driving || (g.flights?.some(f => f.leg_type === 'arrival') && g.flights?.some(f => f.leg_type === 'departure'))).length
  const missingInfo = localGolfers.length - confirmedGolfers

  const handleToggleDriving = async (golfer: Golfer) => {
    const newState = !golfer.is_driving
    setLocalGolfers(prev => prev.map(g => g.id === golfer.id ? { ...g, is_driving: newState } : g))
    const { error } = await supabase.from('trip_golfers').update({ is_driving: newState }).eq('id', golfer.id)
    if (error) {
      setLocalGolfers(prev => prev.map(g => g.id === golfer.id ? { ...g, is_driving: !newState } : g))
      alert("Error: " + error.message)
    } else {
      onUpdate()
    }
  }

  const handleOpenModal = (gId: string, type: 'arrival' | 'departure', flight?: Flight) => {
    setGolferId(gId); setLegType(type);
    if (flight) {
      setEditingId(flight.id); setAirline(flight.airline); setFlightNum(flight.flight_number); setDepAirport(flight.departure_airport); setArrAirport(flight.arrival_airport);
      
      // FIX: Manual Parsing
      const isoStr = type === 'arrival' ? flight.arrival_time : flight.departure_time
      if (isoStr) {
        const [dStr, tStr] = isoStr.split('T')
        const [y, m, d] = dStr.split('-').map(Number)
        setFlightDate(new Date(y, m - 1, d, 12, 0, 0))
      }

      // Extract times from strings directly
      const depIso = flight.departure_time; const arrIso = flight.arrival_time
      setDepTime(depIso.split('T')[1]?.slice(0, 5) || '')
      setArrTime(arrIso.split('T')[1]?.slice(0, 5) || '')

    } else {
      setEditingId(null); setAirline(''); setFlightNum(''); setDepAirport(''); setArrAirport(''); setFlightDate(null); setDepTime(''); setArrTime('');
    }
    setShowModal(true)
  }

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!flightDate || !depTime || !arrTime || !golferId) return

    // FIX: en-CA format
    const dateStr = flightDate.toLocaleDateString('en-CA')
    const fullDep = `${dateStr}T${depTime}:00`
    const fullArr = `${dateStr}T${arrTime}:00`

    const payload = { golfer_id: golferId, trip_id: tripId, leg_type: legType, airline: airline, flight_number: flightNum, departure_airport: depAirport, arrival_airport: arrAirport, departure_time: fullDep, arrival_time: fullArr }
    
    if (editingId) await supabase.from('golfer_flights').update(payload).eq('id', editingId); else await supabase.from('golfer_flights').insert(payload);
    setShowModal(false); onUpdate()
  }

  const getInitials = (n: string) => n.split(' ').map(c => c[0]).join('').substring(0, 2).toUpperCase()
  
  // FIX: Manual Parsing Helper
  const formatDateTime = (iso: string) => { 
    if (!iso) return { date: '—', time: '—' }
    const [datePart, timePart] = iso.split('T')
    if (!datePart || !timePart) return { date: '—', time: '—' }
    const [y, m, d] = datePart.split('-').map(Number)
    const [h, min] = timePart.split(':').map(Number)
    const localDate = new Date(y, m - 1, d, h, min)
    return { date: localDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), time: localDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) } 
  }

  return (
    <div className="p-8 max-w-7xl mx-auto pb-20">
      <div className="flex justify-between items-center mb-6"><div><h2 className="text-2xl font-bold text-slate-900 tracking-tight">Flight Information</h2><p className="text-sm text-slate-500 mt-1">Track arrivals, departures, and travel status.</p></div></div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div className="bg-white border border-slate-200 rounded-xl p-4 flex items-center gap-4 shadow-sm"><div className="h-12 w-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><span className="material-symbols-outlined">flight_land</span></div><div><p className="text-slate-500 text-xs uppercase font-bold tracking-wider">Arrivals Today</p><p className="text-slate-900 text-xl font-bold">{arrivalsToday} Golfers</p></div></div>
        <div className="bg-white border border-slate-200 rounded-xl p-4 flex items-center gap-4 shadow-sm"><div className="h-12 w-12 rounded-full bg-amber-50 flex items-center justify-center text-amber-600"><span className="material-symbols-outlined">warning</span></div><div><p className="text-slate-500 text-xs uppercase font-bold tracking-wider">Missing Info</p><p className="text-slate-900 text-xl font-bold">{missingInfo} Golfers</p></div></div>
        <div className="bg-white border border-slate-200 rounded-xl p-4 flex items-center gap-4 shadow-sm"><div className="h-12 w-12 rounded-full bg-green-50 flex items-center justify-center text-[#1a4d2e]"><span className="material-symbols-outlined">check_circle</span></div><div><p className="text-slate-500 text-xs uppercase font-bold tracking-wider">Confirmed</p><p className="text-slate-900 text-xl font-bold">{confirmedGolfers}/{localGolfers.length}</p></div></div>
      </div>
      <div className="flex flex-col gap-4">
        {localGolfers.map((golfer) => {
          const arrival = golfer.flights?.find(f => f.leg_type === 'arrival')
          const departure = golfer.flights?.find(f => f.leg_type === 'departure')
          const isComplete = golfer.is_driving || (arrival && departure)
          const statusText = golfer.is_driving ? 'Driving' : isComplete ? 'Confirmed' : 'Incomplete'
          const statusColor = golfer.is_driving ? 'text-blue-600' : isComplete ? 'text-slate-500' : 'text-amber-600'
          const dotColor = golfer.is_driving ? 'bg-blue-500' : isComplete ? 'bg-[#1a4d2e]' : 'bg-amber-500 animate-pulse'
          return (
            <div key={golfer.id} className="bg-white border border-slate-200 hover:border-[#d4af37] hover:shadow-md rounded-xl p-5 transition-all">
              <div className="flex flex-col xl:flex-row gap-6 items-start xl:items-center">
                <div className="w-full xl:w-auto xl:min-w-[300px] flex items-center justify-between pr-4">
                  <div className="flex items-center gap-4"><div className="relative"><div className="bg-[#1a4d2e]/5 rounded-full h-14 w-14 ring-2 ring-white flex items-center justify-center text-lg font-bold text-[#1a4d2e] border border-[#1a4d2e]/10">{getInitials(golfer.name)}</div><div className="absolute -bottom-1 -right-1 bg-[#d4af37] text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-white shadow-sm">HC {golfer.handicap}</div></div><div><h3 className="text-slate-900 text-lg font-bold leading-tight">{golfer.name}</h3><p className={`text-sm mt-0.5 flex items-center gap-1 font-medium ${statusColor}`}><span className={`w-2 h-2 rounded-full ${dotColor}`}></span>{statusText}</p></div></div>
                  <div className="flex flex-col items-end gap-1 cursor-pointer group" onClick={() => handleToggleDriving(golfer)}><div className={`relative w-9 h-5 rounded-full transition-colors duration-200 ${golfer.is_driving ? 'bg-blue-500' : 'bg-slate-200'}`}><div className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform duration-200 ${golfer.is_driving ? 'translate-x-4' : 'translate-x-0'}`}></div></div><span className={`text-[10px] font-bold uppercase tracking-wider group-hover:text-blue-500 transition-colors ${golfer.is_driving ? 'text-blue-500' : 'text-slate-300'}`}>Driving</span></div>
                </div>
                <div className="w-full xl:flex-1">
                  {golfer.is_driving ? (
                    <div className="h-full min-h-[100px] bg-blue-50/50 border border-blue-100 rounded-lg flex flex-col items-center justify-center text-blue-600 gap-2"><div className="flex items-center gap-2 opacity-80"><span className="material-symbols-outlined text-2xl">directions_car</span><span className="font-bold text-sm">Traveling by Car</span></div></div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {arrival ? (
                        <div onClick={() => handleOpenModal(golfer.id, 'arrival', arrival)} className="cursor-pointer bg-slate-50 rounded-lg p-4 border-l-4 border-[#1a4d2e] relative overflow-hidden hover:bg-slate-100 transition-colors"><div className="absolute top-0 right-0 p-2 opacity-5"><span className="material-symbols-outlined text-6xl -mr-4 -mt-4 rotate-45">flight</span></div><div className="relative z-10"><div className="flex justify-between items-start mb-2"><div className="flex items-center gap-2"><span className="text-[10px] font-bold text-[#1a4d2e] uppercase bg-white px-2 py-0.5 rounded shadow-sm">Arrival</span><span className="text-xs text-slate-500 font-medium">{formatDateTime(arrival.arrival_time).date}</span></div><div className="text-[10px] font-mono text-slate-500 bg-white px-1.5 py-0.5 rounded border border-slate-200">{arrival.airline} {arrival.flight_number}</div></div><div className="flex items-end justify-between"><div><div className="flex items-center gap-2 text-slate-900 font-mono text-lg font-bold"><span>{arrival.departure_airport}</span><span className="material-symbols-outlined text-sm text-[#d4af37]">arrow_forward</span><span>{arrival.arrival_airport}</span></div></div><div className="text-xl font-bold text-slate-900">{formatDateTime(arrival.arrival_time).time}</div></div></div></div>
                      ) : (
                        <button onClick={() => handleOpenModal(golfer.id, 'arrival')} className="bg-white rounded-lg border border-dashed border-slate-300 p-4 flex flex-col items-center justify-center min-h-[100px] hover:bg-slate-50 hover:border-[#1a4d2e] transition-colors group"><span className="material-symbols-outlined text-slate-400 group-hover:text-[#1a4d2e]">add</span><p className="text-xs font-medium text-slate-500 group-hover:text-[#1a4d2e] mt-1">Add Arrival</p></button>
                      )}
                      {departure ? (
                        <div onClick={() => handleOpenModal(golfer.id, 'departure', departure)} className="cursor-pointer bg-slate-50 rounded-lg p-4 border-l-4 border-[#d4af37] relative overflow-hidden hover:bg-slate-100 transition-colors"><div className="absolute top-0 right-0 p-2 opacity-5"><span className="material-symbols-outlined text-6xl -mr-4 -mt-4 -rotate-45">flight</span></div><div className="relative z-10"><div className="flex justify-between items-start mb-2"><div className="flex items-center gap-2"><span className="text-[10px] font-bold text-amber-700 uppercase bg-white px-2 py-0.5 rounded shadow-sm">Departure</span><span className="text-xs text-slate-500 font-medium">{formatDateTime(departure.departure_time).date}</span></div><div className="text-[10px] font-mono text-slate-500 bg-white px-1.5 py-0.5 rounded border border-slate-200">{departure.airline} {departure.flight_number}</div></div><div className="flex items-end justify-between"><div><div className="flex items-center gap-2 text-slate-900 font-mono text-lg font-bold"><span>{departure.departure_airport}</span><span className="material-symbols-outlined text-sm text-[#d4af37]">arrow_forward</span><span>{departure.arrival_airport}</span></div></div><div className="text-xl font-bold text-slate-900">{formatDateTime(departure.departure_time).time}</div></div></div></div>
                      ) : (
                        <button onClick={() => handleOpenModal(golfer.id, 'departure')} className="bg-white rounded-lg border border-dashed border-slate-300 p-4 flex flex-col items-center justify-center min-h-[100px] hover:bg-slate-50 hover:border-[#1a4d2e] transition-colors group"><span className="material-symbols-outlined text-slate-400 group-hover:text-[#1a4d2e]">add</span><p className="text-xs font-medium text-slate-500 group-hover:text-[#1a4d2e] mt-1">Add Departure</p></button>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )
        })}
      </div>

      {showModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm" onClick={() => setShowModal(false)}>
          <div className="bg-white p-6 rounded-xl w-full max-w-md shadow-xl" onClick={e => e.stopPropagation()}>
            <div className="flex items-center gap-3 mb-6 border-b border-gray-100 pb-4"><span className="material-symbols-outlined text-[#1a4d2e]">{legType === 'arrival' ? 'flight_land' : 'flight_takeoff'}</span><h3 className="text-xl font-bold text-[#0d2818]">{editingId ? 'Edit' : 'Add'} {legType === 'arrival' ? 'Arrival' : 'Departure'}</h3></div>
            <form onSubmit={handleSave} className="flex flex-col gap-5">
              <div className="grid grid-cols-2 gap-4"><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Airline</label><input value={airline} onChange={e => setAirline(e.target.value)} className="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="Delta" required /></div><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Flight #</label><input value={flightNum} onChange={e => setFlightNum(e.target.value)} className="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="DL123" required /></div></div>
              <div className="grid grid-cols-2 gap-4"><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Departing</label><input value={depAirport} onChange={e => setDepAirport(e.target.value)} className="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="MSP" maxLength={3} required /></div><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Arriving</label><input value={arrAirport} onChange={e => setArrAirport(e.target.value)} className="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="PHX" maxLength={3} required /></div></div>
              <div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Date</label><div className="border rounded-lg p-1 bg-white"><DatePicker selected={flightDate} onChange={(date: Date | null) => setFlightDate(date)} className="w-full p-2 outline-none" placeholderText="Select Date" required /></div></div>
              <div className="grid grid-cols-2 gap-4"><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Depart Time</label><input type="time" value={depTime} onChange={e => setDepTime(e.target.value)} className="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-[#1a4d2e]" required /></div><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Arrive Time</label><input type="time" value={arrTime} onChange={e => setArrTime(e.target.value)} className="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-[#1a4d2e]" required /></div></div>
              <div className="flex gap-2 mt-4 pt-4 border-t border-gray-100"><button type="button" onClick={() => setShowModal(false)} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-lg">Cancel</button><button type="submit" className="flex-1 py-3 bg-[#1a4d2e] text-white font-bold rounded-lg hover:bg-[#143a22]">Save Flight</button></div>
            </form>
          </div>
        </div>
      )}
    </div>
  )
}
</file>

<file path="app/trip/components/TripGolf.tsx">
'use client'

import { useState, useRef, useEffect } from 'react'
import { createBrowserClient } from '@supabase/ssr'
import DatePicker from 'react-datepicker'
import "react-datepicker/dist/react-datepicker.css"
import { Round, Golfer, RoundWeather, Course } from '../types'

const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

export default function TripGolf({ 
  tripId, 
  rounds, 
  golfers, 
  weatherMap, 
  onUpdate 
}: { 
  tripId: string, 
  rounds: Round[], 
  golfers: Golfer[], 
  weatherMap: Record<string, RoundWeather>, 
  onUpdate: () => void 
}) {
  // --- STATE ---
  const [showModal, setShowModal] = useState(false)
  const [editingRoundId, setEditingRoundId] = useState<string | null>(null)

  // Form State
  const [courseName, setCourseName] = useState('')
  const [courseAddress, setCourseAddress] = useState('')
  const [courseCity, setCourseCity] = useState('')
  const [courseState, setCourseState] = useState('')
  const [courseZip, setCourseZip] = useState('')
  const [roundDate, setRoundDate] = useState<Date | null>(null)
  const [teeTime, setTeeTime] = useState('')
  const [selectedGolferIds, setSelectedGolferIds] = useState<string[]>([])

  // Search State
  const [searchResults, setSearchResults] = useState<Course[]>([])
  const [showDropdown, setShowDropdown] = useState(false)
  const wrapperRef = useRef<HTMLDivElement>(null)

  // --- HELPERS ---
  const getInitials = (name: string) => name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
  
  const formatDate = (dateStr: string) => new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })
  
  const formatTime = (timeStr: string) => { 
    if (!timeStr) return ''
    const [hours, minutes] = timeStr.split(':')
    const h = parseInt(hours, 10)
    const suffix = h >= 12 ? 'PM' : 'AM'
    const h12 = h % 12 || 12
    return `${h12}:${minutes} ${suffix}` 
  }

  const buildAddressString = (course?: any) => { 
    if (!course) return ''
    const parts = [course.address, course.city, course.state, course.zip_code].filter(Boolean)
    return parts.join(', ') 
  }

  const toggleGolferSelection = (id: string) => { 
    if (selectedGolferIds.includes(id)) setSelectedGolferIds(selectedGolferIds.filter(g => g !== id))
    else setSelectedGolferIds([...selectedGolferIds, id]) 
  }

  // Close dropdown if clicked outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {
        setShowDropdown(false)
      }
    }
    document.addEventListener("mousedown", handleClickOutside)
    return () => document.removeEventListener("mousedown", handleClickOutside)
  }, [])

  // --- SEARCH LOGIC ---
  const handleSearchChange = async (val: string) => {
    setCourseName(val)
    
    if (val.length < 2) {
      setSearchResults([])
      setShowDropdown(false)
      return
    }

    const { data } = await supabase
      .from('courses')
      .select('*')
      .ilike('name', `%${val}%`)
      .limit(5)

    if (data && data.length > 0) {
      setSearchResults(data)
      setShowDropdown(true)
    } else {
      setSearchResults([])
      setShowDropdown(false)
    }
  }

  const handleSelectCourse = (course: Course) => {
    setCourseName(course.name)
    setCourseAddress(course.address || '')
    setCourseCity(course.city || '')
    setCourseState(course.state || '')
    setCourseZip(course.zip_code || '')
    setShowDropdown(false)
  }

  // --- GROUPING LOGIC ---
  const roundsByDate = rounds.reduce((acc: Record<string, Round[]>, round) => { 
    const date = round.round_date
    if (!acc[date]) acc[date] = []
    acc[date].push(round)
    return acc 
  }, {})
  
  const sortedDates = Object.keys(roundsByDate).sort((a, b) => new Date(a).getTime() - new Date(b).getTime())

  // --- ACTIONS ---
  const handleOpenRoundModal = (round?: Round) => {
    if (round) {
      setEditingRoundId(round.id)
      setCourseName(round.courses?.name || '')
      setCourseAddress(round.courses?.address || '')
      setCourseCity(round.courses?.city || '')
      setCourseState(round.courses?.state || '')
      setCourseZip(round.courses?.zip_code || '')
      setRoundDate(new Date(round.round_date + 'T12:00:00')) 
      setTeeTime(round.tee_time)
      setSelectedGolferIds(round.round_players?.map(p => p.trip_golfers.id) || [])
    } else {
      setEditingRoundId(null)
      setCourseName('')
      setCourseAddress('')
      setCourseCity('')
      setCourseState('')
      setCourseZip('')
      setRoundDate(null)
      setTeeTime('')
      setSelectedGolferIds([])
    }
    setShowModal(true)
    setShowDropdown(false)
  }

  const handleSaveRound = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!courseName || !roundDate || !teeTime || !tripId) return
    
    const dateStr = roundDate.toISOString().split('T')[0]
    let courseId = null

    // 1. Check if course exists or create new
    const { data: existingCourse } = await supabase.from('courses').select('id').ilike('name', courseName).single()
    
    if (existingCourse) {
      courseId = existingCourse.id
    } else {
      const { data: newCourse } = await supabase.from('courses').insert({ 
        name: courseName, 
        address: courseAddress, 
        city: courseCity, 
        state: courseState, 
        zip_code: courseZip 
      }).select().single()
      if (newCourse) courseId = newCourse.id
    }

    if (!courseId) return alert('Error saving course')

    let roundId = editingRoundId

    // 2. Insert or Update Round
    if (editingRoundId) {
      await supabase.from('rounds').update({ 
        course_id: courseId, 
        round_date: dateStr, 
        tee_time: teeTime 
      }).eq('id', editingRoundId)
    } else {
      const { data: newRound } = await supabase.from('rounds').insert({ 
        trip_id: tripId, 
        course_id: courseId, 
        round_date: dateStr, 
        tee_time: teeTime 
      }).select().single()
      if (newRound) roundId = newRound.id
    }

    // 3. Update Players (Delete all, re-insert)
    if (roundId) {
      await supabase.from('round_players').delete().eq('round_id', roundId)
      if (selectedGolferIds.length > 0) {
        await supabase.from('round_players').insert(
          selectedGolferIds.map(gid => ({ round_id: roundId, golfer_id: gid }))
        )
      }
    }

    setShowModal(false)
    onUpdate()
  }

  return (
    <div className="p-8 max-w-5xl mx-auto flex flex-col gap-8 pb-20">
      
      {/* --- HEADER (Title Only) --- */}
      <div>
        <h2 className="text-2xl font-bold text-slate-900 tracking-tight">Golf Itinerary</h2>
        <p className="text-sm text-slate-500 mt-1">Tee times, courses, and pairings</p>
      </div>

      {/* --- STATS BAR --- */}
      <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div className="flex items-center gap-4 rounded-xl bg-white p-4 shadow-sm border border-slate-200">
          <div className="flex h-10 w-10 items-center justify-center rounded-full bg-[#1a4d2e]/10 text-[#1a4d2e]">
            <span className="material-symbols-outlined">golf_course</span>
          </div>
          <div>
            <p className="text-sm font-medium text-slate-500">Total Rounds</p>
            <p className="text-xl font-bold text-slate-900">{rounds.length} Rounds</p>
          </div>
        </div>
        <div className="flex items-center gap-4 rounded-xl bg-white p-4 shadow-sm border border-slate-200">
          <div className="flex h-10 w-10 items-center justify-center rounded-full bg-blue-100 text-blue-700">
            <span className="material-symbols-outlined">groups</span>
          </div>
          <div>
            <p className="text-sm font-medium text-slate-500">Golfers</p>
            <p className="text-xl font-bold text-slate-900">{golfers.length} Players</p>
          </div>
        </div>
      </div>

      {/* --- TIMELINE --- */}
      {sortedDates.map((dateStr) => {
        const dayRounds = roundsByDate[dateStr]
        return (
          <div key={dateStr} className="flex flex-col gap-6">
            
            {/* Date Header */}
            <div className="flex items-center gap-4">
              <div className="flex h-8 w-8 items-center justify-center rounded-full bg-slate-200 text-sm font-bold text-slate-600">
                {dayRounds.length}
              </div>
              <h3 className="text-lg font-bold text-slate-900">{formatDate(dateStr)}</h3>
              <div className="h-px flex-1 bg-slate-200"></div>
            </div>

            {/* Round Cards */}
            {dayRounds.map(round => {
              const weather = weatherMap[round.id]
              const playerCount = round.round_players?.length || 0
              const isPractice = round.courses?.name?.toLowerCase().includes('range') || round.courses?.name?.toLowerCase().includes('practice')
              const cardOpacity = isPractice ? 'opacity-90 hover:opacity-100 bg-slate-50' : 'bg-white'
              
              return (
                <div key={round.id} className={`group relative flex flex-col overflow-hidden rounded-2xl ${cardOpacity} shadow-sm border border-slate-200 transition-all hover:shadow-md`}>
                  
                  {/* Edit Button (Hidden until hover) */}
                  <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onClick={() => handleOpenRoundModal(round)} className="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-[#1a4d2e] hover:text-white transition-colors">
                      <span className="material-symbols-outlined text-[16px]">edit</span>
                    </button>
                  </div>

                  <div className="flex flex-col p-6">
                    {/* Top Badges */}
                    <div className="flex items-start justify-between mb-2">
                      <div className="flex items-center gap-3">
                        <span className={`inline-flex items-center rounded-md px-2 py-1 text-xs font-bold ring-1 ring-inset ${isPractice ? 'bg-slate-200 text-slate-700 ring-slate-300' : 'bg-[#1a4d2e]/10 text-[#1a4d2e] ring-[#1a4d2e]/20'}`}>
                          {formatTime(round.tee_time)} {isPractice ? 'Event Time' : 'Tee Time'}
                        </span>
                        
                        {/* WEATHER BADGE */}
                        {weather && weather.temp !== null && (
                          <div className="flex items-center gap-1 bg-[#d4af37] text-white rounded-full pr-2 pl-1 py-0.5 text-[10px] font-bold shadow-sm select-none">
                            <div className="relative w-5 h-5 flex-shrink-0">
                              {weather.icon && (
                                <img 
                                  src={`https://openweathermap.org/img/wn/${weather.icon}@2x.png`} 
                                  alt={weather.description} 
                                  className="absolute inset-0 w-full h-full object-contain"
                                />
                              )}
                            </div>
                            <span className="leading-none mt-[1px]">{weather.temp}°F</span>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Course Info */}
                    <h3 className={`text-2xl font-bold ${isPractice ? 'text-slate-700' : 'text-slate-900'} group-hover:text-[#1a4d2e] transition-colors`}>
                      {round.courses?.name}
                    </h3>
                    {round.courses && (
                      <div className="mt-2 flex items-center gap-2 text-sm text-slate-500">
                        <span className="material-symbols-outlined text-slate-400 text-[18px]">location_on</span>
                        <span>{buildAddressString(round.courses)}</span>
                      </div>
                    )}

                    {/* Footer / Attendees */}
                    <div className="mt-6 flex flex-wrap items-center justify-between gap-4 border-t border-slate-100 pt-4">
                      <div className="flex items-center gap-3">
                        <span className="text-xs font-semibold uppercase tracking-wider text-slate-500">
                          {isPractice ? 'Attendees' : 'Tee Sheet'} ({playerCount})
                        </span>
                        <div className="flex items-center -space-x-2">
                          {round.round_players?.map((p, i) => (
                            <div key={i} className="flex h-8 w-8 items-center justify-center rounded-full ring-2 ring-white bg-slate-100 text-xs font-bold text-slate-600" title={p.trip_golfers.name}>
                              {getInitials(p.trip_golfers.name)}
                            </div>
                          ))}
                        </div>
                        {playerCount === 0 && <span className="text-xs text-slate-400 italic">No players assigned</span>}
                      </div>
                      
                      {/* Pairings Button (Hidden) */}
                      {!isPractice && (
                        <div className="hidden flex items-center gap-2">
                          <button className="text-xs font-medium text-[#1a4d2e] hover:underline opacity-50 cursor-not-allowed" title="Coming Soon">View Pairing Details</button>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )
            })}
          </div>
        )
      })}

      {/* --- ADD BUTTON (Bottom) --- */}
      <div className="mt-8 flex justify-center">
        <button onClick={() => handleOpenRoundModal()} className="group flex items-center gap-2 rounded-full border border-dashed border-slate-300 px-6 py-3 text-sm font-medium text-slate-500 transition-all hover:border-[#1a4d2e] hover:bg-[#1a4d2e]/5 hover:text-[#1a4d2e]">
          <span className="material-symbols-outlined transition-transform group-hover:rotate-90">add</span> Add Another Round
        </button>
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={() => setShowModal(false)}></div>
          <div className="relative w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden animate-[fadeInUp_0.2s_ease-out] flex flex-col max-h-[90vh]">
            <div className="p-6 border-b border-gray-100">
              <h3 className="text-xl font-bold text-[#0d2818]">{editingRoundId ? 'Edit Round' : 'Add New Round'}</h3>
            </div>
            <div className="p-6 overflow-y-auto">
              <form onSubmit={handleSaveRound} className="flex flex-col gap-5">
                
                {/* Course Inputs (Type-Ahead) */}
                <div className="flex flex-col gap-3">
                  <label className="text-xs font-bold uppercase text-gray-500">Course Details</label>
                  
                  {/* Search Wrapper */}
                  <div className="relative" ref={wrapperRef}>
                    <input 
                      value={courseName} 
                      onChange={e => handleSearchChange(e.target.value)} 
                      className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" 
                      placeholder="Search Course Name..." 
                      required 
                    />
                    
                    {/* DROPDOWN RESULTS */}
                    {showDropdown && searchResults.length > 0 && (
                      <ul className="absolute z-10 w-full bg-white border border-gray-200 rounded-lg mt-1 shadow-xl max-h-60 overflow-y-auto animate-[fadeIn_0.1s_ease-out]">
                        {searchResults.map((course) => (
                          <li 
                            key={course.id} 
                            onClick={() => handleSelectCourse(course)}
                            className="p-3 hover:bg-slate-50 cursor-pointer text-sm border-b border-gray-50 last:border-0 transition-colors"
                          >
                            <div className="font-bold text-slate-900">{course.name}</div>
                            <div className="text-xs text-slate-500">{course.city}, {course.state}</div>
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>

                  <input value={courseAddress} onChange={e => setCourseAddress(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="Street Address" />
                  <div className="grid grid-cols-2 gap-3">
                    <input value={courseCity} onChange={e => setCourseCity(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="City" />
                    <div className="grid grid-cols-2 gap-3">
                      <input value={courseState} onChange={e => setCourseState(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="ST" />
                      <input value={courseZip} onChange={e => setCourseZip(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="Zip" />
                    </div>
                  </div>
                </div>

                {/* Date & Time */}
                <div className="grid grid-cols-2 gap-4">
                  <div className="flex flex-col gap-2">
                    <label className="text-xs font-bold uppercase text-gray-500">Date</label>
                    <div className="border border-gray-200 rounded-lg p-1 bg-white focus-within:ring-2 focus-within:ring-[#1a4d2e]">
                      <DatePicker selected={roundDate} onChange={(date: Date | null) => setRoundDate(date)} className="w-full p-2 outline-none" placeholderText="Select Date" required />
                    </div>
                  </div>
                  <div className="flex flex-col gap-2">
                    <label className="text-xs font-bold uppercase text-gray-500">Tee Time</label>
                    <input type="time" value={teeTime} onChange={e => setTeeTime(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" required />
                  </div>
                </div>

                {/* Player Select */}
                <div className="flex flex-col gap-2">
                  <label className="text-xs font-bold uppercase text-gray-500">Select Players</label>
                  <div className="border border-gray-200 rounded-lg max-h-40 overflow-y-auto divide-y divide-gray-100">
                    {golfers.map(golfer => (
                      <div key={golfer.id} onClick={() => toggleGolferSelection(golfer.id)} className={`p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 ${selectedGolferIds.includes(golfer.id) ? 'bg-[#1a4d2e]/5' : ''}`}>
                        <span className="text-sm font-medium text-slate-700">{golfer.name}</span>
                        {selectedGolferIds.includes(golfer.id) && (
                          <span className="material-symbols-outlined text-[#1a4d2e] text-sm">check_circle</span>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Buttons */}
                <div className="flex gap-2 mt-4 pt-4 border-t border-gray-100">
                  <button type="button" onClick={() => setShowModal(false)} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-lg">Cancel</button>
                  <button type="submit" className="flex-1 py-3 bg-[#1a4d2e] text-white font-bold rounded-lg hover:bg-[#143a22]">{editingRoundId ? 'Save Changes' : 'Create Round'}</button>
                </div>

              </form>
            </div>
          </div>
        </div>
      )}

    </div>
  )
}
</file>

<file path="app/trip/components/TripLodging.tsx">
'use client'

import { useState } from 'react'
import { createBrowserClient } from '@supabase/ssr'
import DatePicker from 'react-datepicker'
import "react-datepicker/dist/react-datepicker.css"
import { Lodging, Trip } from '../types'

const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

export default function TripLodging({ 
  tripId, 
  lodgings, 
  trip, 
  onUpdate 
}: { 
  tripId: string, 
  lodgings: Lodging[], 
  trip: Trip | null, 
  onUpdate: () => void 
}) {
  // --- STATE ---
  const [showModal, setShowModal] = useState(false)
  const [editingId, setEditingId] = useState<string | null>(null)

  // Form State
  const [name, setName] = useState('')
  const [address, setAddress] = useState('')
  const [city, setCity] = useState('')
  const [state, setState] = useState('')
  const [zip, setZip] = useState('')
  const [url, setUrl] = useState('')
  const [checkInDate, setCheckInDate] = useState<Date | null>(null)
  const [checkInTime, setCheckInTime] = useState('15:00')
  const [checkOutDate, setCheckOutDate] = useState<Date | null>(null)
  const [checkOutTime, setCheckOutTime] = useState('11:00')

  // --- STATS ---
  let totalNights = 0
  if (trip) {
    const start = new Date(trip.start_date)
    const end = new Date(trip.end_date)
    totalNights = Math.max(0, Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)))
  }
  
  const coveredNights = lodgings.reduce((acc, lodge) => {
    const start = new Date(lodge.check_in_time)
    const end = new Date(lodge.check_out_time)
    const duration = Math.max(0, Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)))
    return acc + duration
  }, 0)

  // --- HANDLERS ---
  const handleOpenModal = (lodge?: Lodging) => {
    if (lodge) {
      setEditingId(lodge.id)
      setName(lodge.name)
      setAddress(lodge.street_address)
      setCity(lodge.city || '')
      setState(lodge.state || '')
      setZip(lodge.zip_code || '')
      setUrl(lodge.website_url || '')
      
      // FIX: Manually parse ISO strings to avoid timezone shift
      if (lodge.check_in_time) {
        const [dStr, tStr] = lodge.check_in_time.split('T')
        const [y, m, d] = dStr.split('-').map(Number)
        setCheckInDate(new Date(y, m - 1, d, 12, 0, 0))
        setCheckInTime(tStr.slice(0, 5))
      }

      if (lodge.check_out_time) {
        const [dStr, tStr] = lodge.check_out_time.split('T')
        const [y, m, d] = dStr.split('-').map(Number)
        setCheckOutDate(new Date(y, m - 1, d, 12, 0, 0))
        setCheckOutTime(tStr.slice(0, 5))
      }
    } else {
      setEditingId(null)
      setName(''); setAddress(''); setCity(''); setState(''); setZip(''); setUrl('')
      setCheckInDate(null); setCheckInTime('15:00')
      setCheckOutDate(null); setCheckOutTime('11:00')
    }
    setShowModal(true)
  }

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!name || !checkInDate || !checkOutDate || !tripId) return

    // FIX: Use 'en-CA' for stable local YYYY-MM-DD
// Inside TripLodging.tsx -> handleSave

    // ... existing date string logic ...
    const checkInStr = checkInDate.toLocaleDateString('en-CA')
    const checkOutStr = checkOutDate.toLocaleDateString('en-CA')
    
    const fullCheckIn = `${checkInStr}T${checkInTime}:00`
    const fullCheckOut = `${checkOutStr}T${checkOutTime}:00`

    const payload = {
      trip_id: tripId,
      name: name,
      street_address: address,
      city: city,
      state: state,
      zip_code: zip,
      website_url: url,
      // FIX: Save BOTH the Timestamp AND the Date
      check_in_time: fullCheckIn,
      check_out_time: fullCheckOut,
      check_in_date: checkInStr,   // <--- Added
      check_out_date: checkOutStr  // <--- Added
    }

    if (editingId) {
      await supabase.from('trip_lodging').update(payload).eq('id', editingId)
    } else {
      await supabase.from('trip_lodging').insert(payload)
    }

    setShowModal(false)
    onUpdate()
  }

  const handleDelete = async (id: string) => {
    if (!confirm('Are you sure you want to remove this lodging?')) return
    await supabase.from('trip_lodging').delete().eq('id', id)
    onUpdate()
  }

  // --- HELPER: Timezone-Safe Formatting ---
  const formatDateTime = (iso: string) => {
    if (!iso) return { date: '—', time: '—' }
    
    const [datePart, timePart] = iso.split('T')
    if (!datePart || !timePart) return { date: '—', time: '—' }
    
    const [y, m, d] = datePart.split('-').map(Number)
    const [h, min] = timePart.split(':').map(Number)
    const localDate = new Date(y, m - 1, d, h, min)

    return {
      date: localDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      time: localDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
    }
  }

  const buildMapQuery = (lodge: Lodging) => {
    const parts = [lodge.street_address, lodge.city, lodge.state, lodge.zip_code].filter(Boolean)
    return encodeURIComponent(parts.join(', '))
  }

  return (
    <div className="p-8 max-w-5xl mx-auto pb-20">
      
      {/* HEADER */}
      <div className="mb-8">
        <h2 className="text-2xl font-bold text-slate-900 tracking-tight">Lodging Logistics</h2>
        <p className="text-sm text-slate-500 mt-1">Manage hotels, houses, and check-in details.</p>
      </div>

      {/* STATS */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div className="bg-white rounded-xl border border-slate-200 p-5 shadow-sm flex items-center space-x-4">
          <div className="w-12 h-12 rounded-lg bg-[#1a4d2e]/10 flex items-center justify-center text-[#1a4d2e]"><span className="material-symbols-outlined text-2xl">nights_stay</span></div>
          <div><p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Nights</p><p className="text-2xl font-bold text-slate-900">{totalNights} <span className="text-sm font-medium text-slate-500 font-normal">nights</span></p></div>
        </div>
        <div className="bg-white rounded-xl border border-slate-200 p-5 shadow-sm flex items-center space-x-4">
          <div className="w-12 h-12 rounded-lg bg-[#d4af37]/10 flex items-center justify-center text-[#d4af37]"><span className="material-symbols-outlined text-2xl">bed</span></div>
          <div><p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Nights with Lodging</p><p className="text-2xl font-bold text-slate-900">{coveredNights} <span className="text-sm font-medium text-slate-500 font-normal">covered</span></p></div>
        </div>
      </div>

      {/* LIST */}
      <div className="flex flex-col gap-6">
        {lodgings.map((lodge) => (
          <div key={lodge.id} className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden group hover:border-[#1a4d2e]/50 transition-all hover:shadow-md">
            <div className="h-1.5 bg-[#1a4d2e]"></div>
            <div className="p-6">
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                  <h2 className="text-2xl font-bold text-[#1a4d2e]">{lodge.name}</h2>
                  <div className="flex items-center text-slate-500 text-sm mt-1">
                    <span className="material-symbols-outlined text-lg mr-1 text-[#d4af37]">place</span>
                    <span>{lodge.street_address}{lodge.city ? `, ${lodge.city}` : ''}</span>
                    <a href={`https://www.google.com/maps/search/?api=1&query=$${buildMapQuery(lodge)}`} target="_blank" rel="noopener noreferrer" className="ml-3 text-[#1a4d2e] hover:underline text-xs font-semibold flex items-center transition-colors">View on Map <span className="material-symbols-outlined text-sm ml-0.5">open_in_new</span></a>
                  </div>
                  {lodge.website_url && (<div className="mt-1 flex items-center text-xs"><a href={lodge.website_url.startsWith('http') ? lodge.website_url : `https://${lodge.website_url}`} target="_blank" rel="noopener noreferrer" className="flex items-center text-slate-400 hover:text-[#1a4d2e] transition-colors"><span className="material-symbols-outlined text-sm mr-1">link</span>{lodge.website_url.replace(/^https?:\/\//, '')}</a></div>)}
                </div>
                <div className="flex space-x-2 mt-4 md:mt-0 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button onClick={() => handleOpenModal(lodge)} className="p-2 text-slate-400 hover:text-[#1a4d2e] transition-colors bg-slate-50 hover:bg-slate-100 rounded-lg" title="Edit"><span className="material-symbols-outlined">edit</span></button>
                  <button onClick={() => handleDelete(lodge.id)} className="p-2 text-slate-400 hover:text-red-500 transition-colors bg-slate-50 hover:bg-red-50 rounded-lg" title="Delete"><span className="material-symbols-outlined">delete</span></button>
                </div>
              </div>

              <div className="border-t border-slate-100 pt-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="flex items-center bg-slate-50 rounded-lg p-4 border border-slate-100">
                    <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-[#1a4d2e] border border-slate-200 mr-4 shadow-sm"><span className="material-symbols-outlined text-xl">login</span></div>
                    <div><p className="text-xs font-bold text-slate-400 uppercase mb-0.5">Check-In</p><div className="font-semibold text-slate-800 text-base">{formatDateTime(lodge.check_in_time).date} <span className="text-slate-400 font-normal mx-1">at</span> {formatDateTime(lodge.check_in_time).time}</div></div>
                  </div>
                  <div className="flex items-center bg-slate-50 rounded-lg p-4 border border-slate-100">
                    <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-[#d4af37] border border-slate-200 mr-4 shadow-sm"><span className="material-symbols-outlined text-xl">logout</span></div>
                    <div><p className="text-xs font-bold text-slate-400 uppercase mb-0.5">Check-Out</p><div className="font-semibold text-slate-800 text-base">{formatDateTime(lodge.check_out_time).date} <span className="text-slate-400 font-normal mx-1">at</span> {formatDateTime(lodge.check_out_time).time}</div></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ))}

        <button onClick={() => handleOpenModal()} className="border-2 border-dashed border-slate-300 rounded-xl p-8 flex flex-col items-center justify-center text-center bg-slate-50/50 hover:bg-slate-50 hover:border-[#1a4d2e] transition-all cursor-pointer group w-full min-h-[160px]">
          <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4 group-hover:scale-110 transition-transform duration-300 border border-slate-200 text-slate-400 group-hover:text-[#1a4d2e]"><span className="material-symbols-outlined text-3xl">add</span></div>
          <h3 className="text-lg font-bold text-slate-500 group-hover:text-[#1a4d2e] transition-colors">Add Accommodation</h3>
          <p className="text-slate-400 text-sm mt-1">Book hotels, houses, or airport stays</p>
        </button>
      </div>

      {showModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm" onClick={() => setShowModal(false)}>
          <div className="relative w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden animate-[fadeInUp_0.2s_ease-out]" onClick={e => e.stopPropagation()}>
            <div className="p-6 border-b border-gray-100 flex items-center gap-3"><span className="material-symbols-outlined text-[#1a4d2e]">hotel</span><h3 className="text-xl font-bold text-[#0d2818]">{editingId ? 'Edit Lodging' : 'Add Lodging'}</h3></div>
            <div className="p-6">
              <form onSubmit={handleSave} className="flex flex-col gap-5">
                <div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Name</label><input value={name} onChange={e => setName(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="e.g. Grand Resort" required /></div>
                <div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Street Address</label><input value={address} onChange={e => setAddress(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="123 Fairway Dr" required /></div>
                <div className="grid grid-cols-12 gap-3">
                   <div className="col-span-6 flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">City</label><input value={city} onChange={e => setCity(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="Scottsdale" required /></div>
                   <div className="col-span-3 flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">State</label><input value={state} onChange={e => setState(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="AZ" required /></div>
                   <div className="col-span-3 flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Zip</label><input value={zip} onChange={e => setZip(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="85255" required /></div>
                </div>
                <div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Website URL <span className="font-normal normal-case italic text-gray-400">(Optional)</span></label><input type="url" value={url} onChange={e => setUrl(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="https://airbnb.com/..." /></div>
                <div className="grid grid-cols-2 gap-4"><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Check-In Date</label><div className="border border-gray-200 rounded-lg p-1 bg-white focus-within:ring-2 focus-within:ring-[#1a4d2e]"><DatePicker selected={checkInDate} onChange={(date: Date | null) => setCheckInDate(date)} className="w-full p-2 outline-none" placeholderText="Select Date" required /></div></div><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Check-In Time</label><input type="time" value={checkInTime} onChange={e => setCheckInTime(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" required /></div></div>
                <div className="grid grid-cols-2 gap-4"><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Check-Out Date</label><div className="border border-gray-200 rounded-lg p-1 bg-white focus-within:ring-2 focus-within:ring-[#1a4d2e]"><DatePicker selected={checkOutDate} onChange={(date: Date | null) => setCheckOutDate(date)} className="w-full p-2 outline-none" placeholderText="Select Date" required /></div></div><div className="flex flex-col gap-2"><label className="text-xs font-bold uppercase text-gray-500">Check-Out Time</label><input type="time" value={checkOutTime} onChange={e => setCheckOutTime(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" required /></div></div>
                <div className="flex gap-2 mt-4 pt-4 border-t border-gray-100"><button type="button" onClick={() => setShowModal(false)} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-lg">Cancel</button><button type="submit" className="flex-1 py-3 bg-[#1a4d2e] text-white font-bold rounded-lg hover:bg-[#143a22]">Save Lodging</button></div>
              </form>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
</file>

<file path="app/trip/types.ts">
export interface Trip {
  id: string
  owner_id: string
  trip_name: string
  start_date: string
  end_date: string
  location?: string
}

export interface Golfer {
  id: string
  trip_id: string
  user_id?: string | null
  name: string
  email?: string | null
  handicap: number
  profile_name?: string
  is_driving?: boolean // Added for Flight Logic
  flights?: Flight[]
}

export interface Flight {
  id: string
  golfer_id: string
  trip_id: string
  leg_type: 'arrival' | 'departure'
  airline: string
  flight_number: string
  departure_airport: string
  arrival_airport: string
  departure_time: string
  arrival_time: string
}

export interface Lodging {
  id: string
  trip_id: string
  name: string
  street_address: string
  city?: string
  state?: string
  zip_code?: string
  website_url?: string
  check_in_time: string
  check_out_time: string
}

export interface Dining {
  id: string
  trip_id: string
  name: string
  street_address: string
  city?: string
  state?: string
  zip_code?: string
  website_url?: string
  reservation_time: string
  party_size: number
}

export interface Expense {
  id: string
  trip_id: string
  payer_id: string
  description: string  // Changed from title
  amount: number
  expense_date: string
  split_method: string
  split_among?: string[] // Added array
  created_at?: string
}
// ... rest of the types stay the same

export interface Course {
  id: string
  name: string
  address?: string
  city?: string
  state?: string
  zip_code?: string
}

export interface Round {
  id: string
  trip_id: string
  course_id: string
  round_date: string
  tee_time: string
  courses?: Course
  round_players?: {
    trip_golfers: {
      id: string
      name: string
      handicap: number
    }
  }[]
}

export interface RoundWeather {
  temp: number | null
  description: string
  icon: string
  wind_speed: number | null
  pop: number | null // Probability of Precipitation
}
</file>

<file path="components/ExpenseTracker.tsx">
'use client'

import { useState, useEffect } from 'react'
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

interface Golfer {
  id: string
  name: string
}

interface Expense {
  id: string
  description: string
  amount: number
  expense_date: string
  payer_id: string
  split_among: string[] | null
  trip_golfers: { name: string }
}

interface Props {
  tripId: string
}

export default function ExpenseTracker({ tripId }: Props) {
  const [activeTab, setActiveTab] = useState<'ledger' | 'balances'>('ledger')
  const [expenses, setExpenses] = useState<Expense[]>([])
  const [golfers, setGolfers] = useState<Golfer[]>([])
  const [loading, setLoading] = useState(false)

  // Form State
  const [isFormOpen, setIsFormOpen] = useState(false)
  const [description, setDescription] = useState('')
  const [amount, setAmount] = useState('')
  const [payerId, setPayerId] = useState('')
  
  // Split Logic
  const [splitWith, setSplitWith] = useState<string[]>([]) 

  useEffect(() => {
    fetchData()
  }, [tripId])

  const fetchData = async () => {
    // 1. Get Roster
    const { data: rosterData } = await supabase
      .from('trip_golfers')
      .select('id, name')
      .eq('trip_id', tripId)
      .order('name')
    if (rosterData) setGolfers(rosterData)

    // 2. Get Expenses
    const { data: expenseData } = await supabase
      .from('trip_expenses')
      .select(`*, trip_golfers (name)`)
      .eq('trip_id', tripId)
      .order('expense_date', { ascending: false })

    if (expenseData) setExpenses(expenseData as any)
  }

  const handleAddExpense = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!description || !amount || !payerId) return alert('Please fill in all fields')

    setLoading(true)
    
    const isEveryone = splitWith.length === 0 || splitWith.length === golfers.length
    const splitData = isEveryone ? null : splitWith

    const { error } = await supabase.from('trip_expenses').insert([{
      trip_id: tripId,
      payer_id: payerId,
      description,
      amount: parseFloat(amount),
      split_among: splitData,
      expense_date: new Date().toISOString()
    }])

    if (error) {
      alert('Error adding expense')
    } else {
      resetForm()
      fetchData()
    }
    setLoading(false)
  }

  const handleDelete = async (id: string) => {
    if (!confirm('Delete this expense?')) return
    await supabase.from('trip_expenses').delete().eq('id', id)
    fetchData()
  }

  const resetForm = () => {
    setDescription('')
    setAmount('')
    setPayerId('')
    setSplitWith([])
    setIsFormOpen(false)
  }

  // --- SETTLEMENT MATH ---
  const calculateBalances = () => {
    const balances: Record<string, { paid: number, cost: number, net: number, name: string }> = {}

    golfers.forEach(g => {
      balances[g.id] = { paid: 0, cost: 0, net: 0, name: g.name }
    })

    expenses.forEach(exp => {
      const amt = exp.amount
      
      if (balances[exp.payer_id]) {
        balances[exp.payer_id].paid += amt
      }

      const consumers = (exp.split_among && exp.split_among.length > 0) 
        ? exp.split_among 
        : golfers.map(g => g.id)

      const costPerPerson = amt / consumers.length

      consumers.forEach(consumerId => {
        if (balances[consumerId]) {
          balances[consumerId].cost += costPerPerson
        }
      })
    })

    Object.keys(balances).forEach(id => {
      balances[id].net = balances[id].paid - balances[id].cost
    })

    return Object.values(balances).sort((a, b) => b.net - a.net)
  }

  const balanceData = calculateBalances()
  const totalTripCost = expenses.reduce((sum, item) => sum + item.amount, 0)

  return (
    <div style={containerStyle}>
      {/* Header & Tabs */}
      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
        <h3 style={headerStyle}>💰 Money</h3>
        <div style={tabContainer}>
          <button 
            style={activeTab === 'ledger' ? activeTabStyle : tabStyle} 
            onClick={() => setActiveTab('ledger')}
          >
            Ledger
          </button>
          <button 
            style={activeTab === 'balances' ? activeTabStyle : tabStyle} 
            onClick={() => setActiveTab('balances')}
          >
            Balances
          </button>
        </div>
      </div>

      {/* --- TAB 1: LEDGER --- */}
      {activeTab === 'ledger' && (
        <>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
             <div style={totalBadge}>Trip Total: ${totalTripCost.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
             {!isFormOpen && (
               <button onClick={() => setIsFormOpen(true)} style={actionButton}>+ Add Expense</button>
             )}
          </div>

          {isFormOpen && (
            <form onSubmit={handleAddExpense} style={formStyle}>
              <h4 style={{marginTop: 0, color: '#059669', marginBottom: '10px'}}>Add New Expense</h4>
              
              <div style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                <div style={{flex: 1}}>
                  <label style={labelStyle}>Who Paid?</label>
                  <select style={inputStyle} value={payerId} onChange={e => setPayerId(e.target.value)} required>
                    <option value="">Select Payer...</option>
                    {golfers.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                  </select>
                </div>
                <div style={{flex: 1}}>
                  <label style={labelStyle}>Amount ($)</label>
                  <input type="number" step="0.01" style={inputStyle} value={amount} onChange={e => setAmount(e.target.value)} required />
                </div>
              </div>

              <div style={{marginBottom: '10px'}}>
                <label style={labelStyle}>Description</label>
                <input style={inputStyle} value={description} onChange={e => setDescription(e.target.value)} placeholder="e.g. Costco Run" required />
              </div>

              <div style={{marginBottom: '15px'}}>
                <label style={labelStyle}>Split Among (Leave empty for Everyone)</label>
                <div style={{display: 'flex', flexWrap: 'wrap', gap: '5px'}}>
                  {golfers.map(g => {
                    const isSelected = splitWith.includes(g.id)
                    return (
                      <button
                        key={g.id}
                        type="button"
                        onClick={() => {
                          if (isSelected) setSplitWith(splitWith.filter(id => id !== g.id))
                          else setSplitWith([...splitWith, g.id])
                        }}
                        style={isSelected ? pillSelected : pillNormal}
                      >
                        {g.name}
                      </button>
                    )
                  })}
                </div>
                <div style={{fontSize: '0.75rem', color: '#6b7280', marginTop: '4px'}}>
                  {splitWith.length === 0 ? 'Splitting equally among everyone.' : `Splitting among ${splitWith.length} people.`}
                </div>
              </div>

              <div style={{display: 'flex', gap: '10px'}}>
                <button type="submit" disabled={loading} style={saveBtnStyle}>Save Expense</button>
                <button type="button" onClick={resetForm} style={cancelBtnStyle}>Cancel</button>
              </div>
            </form>
          )}

          {expenses.length === 0 ? (
            <div style={emptyStateContainer}>
               <p style={emptyStateText}>No expenses yet. Add costs here to split them later.</p>
            </div>
          ) : (
            <div style={{display: 'flex', flexDirection: 'column'}}>
              {expenses.map(exp => (
                <div key={exp.id} style={itemRow}>
                  <div style={{flex: 1}}>
                    <div style={{fontWeight: '600', color: '#111827'}}>{exp.description}</div>
                    <div style={{fontSize: '0.85rem', color: '#6b7280'}}>
                      <span style={{fontWeight: '500', color: '#4b5563'}}>{exp.trip_golfers?.name}</span> paid
                      {exp.split_among ? ` for ${exp.split_among.length} people` : ` for everyone`}
                    </div>
                  </div>
                  <div style={{fontWeight: 'bold', color: '#059669', fontSize: '1.1rem', marginRight: '15px'}}>
                    ${exp.amount.toFixed(2)}
                  </div>
                  <button onClick={() => handleDelete(exp.id)} style={deleteBtn}>×</button>
                </div>
              ))}
            </div>
          )}
        </>
      )}

      {/* --- TAB 2: BALANCES --- */}
      {activeTab === 'balances' && (
        <div>
          <div style={{marginBottom: '15px', fontSize: '0.9rem', color: '#4b5563', lineHeight: '1.4'}}>
            <strong>How to read this:</strong> <br/>
            <span style={{color: '#059669', fontWeight: 'bold'}}>Green</span> means you are owed money (you paid more than your share). <br/>
            <span style={{color: '#dc2626', fontWeight: 'bold'}}>Red</span> means you owe money (you haven't paid enough yet).
          </div>
          
          <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
            {balanceData.map(b => (
              <div key={b.name} style={balanceCard}>
                <div style={{fontWeight: 'bold', fontSize: '1rem', color: '#111827'}}>{b.name}</div>
                <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                   <div style={{fontSize: '0.8rem', color: '#6b7280'}}>
                     Paid: ${b.paid.toFixed(0)} | Share: ${b.cost.toFixed(0)}
                   </div>
                   <div style={{
                     fontWeight: 'bold', 
                     color: b.net >= 0 ? '#059669' : '#dc2626',
                     backgroundColor: b.net >= 0 ? '#ecfdf5' : '#fef2f2',
                     padding: '2px 8px', borderRadius: '4px'
                   }}>
                     {b.net >= 0 ? '+' : ''}${b.net.toFixed(2)}
                   </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

// Styles
const containerStyle: React.CSSProperties = { backgroundColor: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', marginBottom: '20px', border: '1px solid #e5e7eb' }
const headerStyle: React.CSSProperties = { margin: 0, color: '#111827', fontSize: '1.1rem' }
const tabContainer: React.CSSProperties = { display: 'flex', gap: '5px', backgroundColor: '#f3f4f6', padding: '3px', borderRadius: '8px' }
const tabStyle: React.CSSProperties = { border: 'none', backgroundColor: 'transparent', padding: '6px 12px', borderRadius: '6px', fontSize: '0.85rem', cursor: 'pointer', color: '#6b7280' }
const activeTabStyle: React.CSSProperties = { ...tabStyle, backgroundColor: 'white', color: '#111827', fontWeight: 'bold', boxShadow: '0 1px 2px rgba(0,0,0,0.1)' }
const totalBadge: React.CSSProperties = { backgroundColor: '#ecfdf5', color: '#065f46', padding: '4px 12px', borderRadius: '20px', fontWeight: 'bold', fontSize: '0.9rem', border: '1px solid #a7f3d0' }
const actionButton: React.CSSProperties = { padding: '6px 12px', backgroundColor: '#059669', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '600', fontSize: '0.85rem' }
const formStyle: React.CSSProperties = { backgroundColor: '#f9fafb', padding: '15px', borderRadius: '8px', border: '1px solid #e5e7eb', marginBottom: '20px' }
const labelStyle: React.CSSProperties = { display: 'block', fontSize: '0.8rem', color: '#374151', marginBottom: '4px', fontWeight: 'bold' }
const inputStyle: React.CSSProperties = { width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid #d1d5db', fontSize: '0.9rem', boxSizing: 'border-box' }
const saveBtnStyle: React.CSSProperties = { padding: '8px 16px', backgroundColor: '#059669', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontWeight: '600' }
const cancelBtnStyle: React.CSSProperties = { padding: '8px 16px', backgroundColor: 'transparent', color: '#6b7280', border: '1px solid #d1d5db', borderRadius: '4px', cursor: 'pointer' }
const itemRow: React.CSSProperties = { display: 'flex', alignItems: 'center', padding: '12px 0', borderBottom: '1px solid #f3f4f6' }
const deleteBtn: React.CSSProperties = { backgroundColor: 'transparent', border: 'none', color: '#ef4444', fontSize: '1.2rem', cursor: 'pointer', fontWeight: 'bold' }
const pillNormal: React.CSSProperties = { padding: '4px 8px', borderRadius: '12px', border: '1px solid #d1d5db', backgroundColor: 'white', fontSize: '0.8rem', cursor: 'pointer', color: '#374151' }
const pillSelected: React.CSSProperties = { padding: '4px 8px', borderRadius: '12px', border: '1px solid #059669', backgroundColor: '#ecfdf5', fontSize: '0.8rem', cursor: 'pointer', color: '#065f46', fontWeight: 'bold' }
const balanceCard: React.CSSProperties = { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px', backgroundColor: '#f9fafb', borderRadius: '6px', border: '1px solid #e5e7eb' }
const emptyStateContainer: React.CSSProperties = { padding: '20px 0', textAlign: 'center' }
const emptyStateText: React.CSSProperties = { color: '#9ca3af', fontStyle: 'italic', fontSize: '0.9rem', margin: 0 }
</file>

<file path="components/FlightDashboard.tsx">
'use client'

import { useState, useEffect } from 'react'
import { createClient } from '@supabase/supabase-js'
import { formatTime } from '@/utils/format'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

interface FlightLeg {
  id: string
  golfer_name: string
  airline: string
  flight_number: string
  airport: string
  time: string
}

interface Props {
  tripId: string
}

export default function FlightDashboard({ tripId }: Props) {
  const [arrivals, setArrivals] = useState<FlightLeg[]>([])
  const [departures, setDepartures] = useState<FlightLeg[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    fetchFlights()
  }, [tripId])

  const fetchFlights = async () => {
    // Fetch golfers and their flights
    const { data: golfers } = await supabase
      .from('trip_golfers')
      .select(`
        name,
        flights:golfer_flights(*)
      `)
      .eq('trip_id', tripId)

    if (golfers) {
      const arr: FlightLeg[] = []
      const dep: FlightLeg[] = []

      golfers.forEach((golfer: any) => {
        golfer.flights.forEach((f: any) => {
          if (!f.arrival_time && !f.departure_time) return

          const leg = {
            id: f.id,
            golfer_name: golfer.name,
            airline: f.airline,
            flight_number: f.flight_number,
            airport: f.leg_type === 'arrival' ? f.arrival_airport : f.departure_airport,
            time: f.leg_type === 'arrival' ? f.arrival_time : f.departure_time
          }

          if (f.leg_type === 'arrival' && leg.time) {
            arr.push(leg)
          } else if (f.leg_type === 'departure' && leg.time) {
            dep.push(leg)
          }
        })
      })

      // Sort by Time (Earliest First)
      arr.sort((a, b) => new Date(a.time).getTime() - new Date(b.time).getTime())
      dep.sort((a, b) => new Date(a.time).getTime() - new Date(b.time).getTime())

      setArrivals(arr)
      setDepartures(dep)
    }
    setLoading(false)
  }

  if (loading) return <div style={containerStyle}>Loading flights...</div>
  if (arrivals.length === 0 && departures.length === 0) return null // Don't show if no data

  return (
    <div style={containerStyle}>
      <h3 style={headerStyle}>✈️ Airport Logistics</h3>
      
      <div style={gridStyle}>
        {/* ARRIVALS COLUMN */}
        <div style={columnStyle}>
          <div style={subHeaderStyle}>
            <span style={{marginRight: '8px'}}>🛬</span> 
            Incoming (Pickups)
          </div>
          {arrivals.length === 0 ? (
            <p style={emptyText}>No arrival flights tracked.</p>
          ) : (
            <div style={listStyle}>
              {arrivals.map(f => (
                <div key={f.id} style={cardStyle}>
                  <div style={timeBadge}>{formatTime(f.time)}</div>
                  <div style={{flex: 1}}>
                    <div style={nameStyle}>{f.golfer_name}</div>
                    <div style={detailStyle}>
                      {f.airline} {f.flight_number} → {f.airport}
                    </div>
                    <div style={dateStyle}>
                      {new Date(f.time).toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'})}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* DEPARTURES COLUMN */}
        <div style={columnStyle}>
          <div style={subHeaderStyle}>
            <span style={{marginRight: '8px'}}>🛫</span> 
            Outgoing (Drop-offs)
          </div>
          {departures.length === 0 ? (
            <p style={emptyText}>No departure flights tracked.</p>
          ) : (
            <div style={listStyle}>
              {departures.map(f => (
                <div key={f.id} style={cardStyle}>
                  <div style={{...timeBadge, backgroundColor: '#fff7ed', color: '#c2410c', border: '1px solid #ffedd5'}}>
                    {formatTime(f.time)}
                  </div>
                  <div style={{flex: 1}}>
                    <div style={nameStyle}>{f.golfer_name}</div>
                    <div style={detailStyle}>
                      {f.airport} → {f.airline} {f.flight_number}
                    </div>
                    <div style={dateStyle}>
                      {new Date(f.time).toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'})}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

// Styles
const containerStyle: React.CSSProperties = { backgroundColor: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', marginBottom: '20px', border: '1px solid #e5e7eb' }
const headerStyle: React.CSSProperties = { marginTop: 0, marginBottom: '20px', color: '#111827', fontSize: '1.2rem' }
const gridStyle: React.CSSProperties = { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px' }
const columnStyle: React.CSSProperties = { backgroundColor: '#f9fafb', borderRadius: '8px', padding: '15px', border: '1px solid #e5e7eb' }
const subHeaderStyle: React.CSSProperties = { fontWeight: 'bold', color: '#374151', marginBottom: '15px', display: 'flex', alignItems: 'center', fontSize: '1rem' }
const listStyle: React.CSSProperties = { display: 'flex', flexDirection: 'column', gap: '10px' }
const cardStyle: React.CSSProperties = { backgroundColor: 'white', padding: '10px', borderRadius: '6px', border: '1px solid #e5e7eb', display: 'flex', gap: '12px', alignItems: 'center', boxShadow: '0 1px 2px rgba(0,0,0,0.03)' }
const timeBadge: React.CSSProperties = { backgroundColor: '#ecfdf5', color: '#047857', padding: '6px 10px', borderRadius: '6px', fontWeight: 'bold', fontSize: '0.9rem', border: '1px solid #d1fae5', minWidth: '70px', textAlign: 'center' }
const nameStyle: React.CSSProperties = { fontWeight: 'bold', color: '#111827', fontSize: '0.95rem' }
const detailStyle: React.CSSProperties = { fontSize: '0.85rem', color: '#4b5563', marginTop: '2px' }
const dateStyle: React.CSSProperties = { fontSize: '0.75rem', color: '#9ca3af', marginTop: '2px' }
const emptyText: React.CSSProperties = { fontStyle: 'italic', color: '#9ca3af', fontSize: '0.9rem' }
</file>

<file path="components/OnboardingModal.tsx">
'use client'

import { useState } from 'react'
// 1. CHANGE THIS IMPORT
import { createBrowserClient } from '@supabase/ssr' 

interface Props {
  userId: string
  onComplete: () => void
}

export default function OnboardingModal({ userId, onComplete }: Props) {
  // 2. INITIALIZE CLIENT INSIDE THE COMPONENT
  // This ensures it has access to the latest browser cookies
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

  const [fullName, setFullName] = useState('')
  const [handicap, setHandicap] = useState('')
  const [loading, setLoading] = useState(false)

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!fullName.trim()) return alert('Please enter your full name')

    setLoading(true)

    // Ensure numeric or null
    const handicapValue = handicap !== '' ? parseFloat(handicap) : null

    // 1. Update Profile
    const { error: profileError } = await supabase
      .from('profiles')
      .upsert({
        id: userId,
        full_name: fullName,
        handicap: handicapValue,
        updated_at: new Date().toISOString(),
      })

    if (profileError) {
      console.error('Error saving profile:', profileError)
      alert('Failed to save profile. Please try again.')
      setLoading(false)
      return
    }

    // 2. Sync to Trip Golfers
    if (handicapValue !== null) {
      // NOTE: We wrap this in a try/catch or simple error log because
      // if the user isn't in a trip yet, this update is expected to yield 0 rows.
      const { error: rosterError } = await supabase
        .from('trip_golfers')
        .update({ 
          handicap: handicapValue,
          name: fullName 
        })
        .eq('user_id', userId)
        
       if (rosterError) console.warn("Roster sync skipped (user likely not in a trip yet)")
    }

    setLoading(false)
    onComplete()
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6 lg:p-8 font-sans text-[#111814]">
      {/* Background with Blur */}
      <div 
        className="fixed inset-0 bg-[#f6f8f6] opacity-95" 
        style={{ backgroundImage: `url('https://www.transparenttextures.com/patterns/cubes.png')` }}
      ></div>
      <div className="absolute inset-0 bg-black/10 backdrop-blur-sm"></div>

      {/* Modal Card */}
      <div className="relative w-full max-w-[560px] bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden animate-[fadeInUp_0.4s_ease-out]">
        
        {/* Header Image */}
        <div 
          className="h-32 w-full bg-cover bg-center relative" 
          style={{ backgroundImage: `url('https://images.unsplash.com/photo-1587174486073-ae5e5cff23aa?q=80&w=2070&auto=format&fit=crop')` }}
        >
          <div className="absolute inset-0 bg-gradient-to-t from-[#1a3c26]/90 to-transparent"></div>
          
          {/* --- SERVER-SIDE SIGN OUT FORM --- */}
          <form action="/auth/signout" method="post">
            <button 
              type="submit"
              className="absolute top-4 right-4 z-10 text-white/90 hover:text-white text-xs font-bold uppercase tracking-wider bg-black/30 hover:bg-black/50 px-4 py-2 rounded-full transition-all backdrop-blur-md border border-white/10 shadow-sm"
            >
              Sign Out
            </button>
          </form>
        </div>

        {/* Content */}
        <div className="p-6 sm:p-8 space-y-8">
          
          {/* Progress & Title */}
          <div className="space-y-4">
            <div className="flex items-center justify-between text-xs font-semibold uppercase tracking-wider text-slate-500">
              <span>Profile Setup</span>
              <span>Step 1 of 1</span>
            </div>
            <div className="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
              <div className="h-full bg-[#d4af37] w-full rounded-full"></div>
            </div>
            <div className="space-y-1 pt-2">
              <h2 className="text-2xl sm:text-3xl font-bold text-[#1a3c26]">Your Golfer Profile</h2>
              <p className="text-slate-500 text-base">Let's get the basics down to personalize your trip.</p>
            </div>
          </div>

          {/* Form */}
          <form onSubmit={handleSave} className="space-y-6">
            
            {/* Name Input */}
            <div className="space-y-2">
              <label className="flex items-center gap-2 text-sm font-bold text-[#0d2818]" htmlFor="fullName">
                <span className="material-symbols-outlined text-[18px] text-[#d4af37]">person</span>
                Full Name
              </label>
              <input 
                id="fullName"
                type="text"
                value={fullName}
                onChange={(e) => setFullName(e.target.value)}
                className="w-full h-12 px-4 rounded-lg bg-[#f6f8f6] border border-slate-200 text-[#0d2818] font-medium placeholder:text-slate-400 focus:border-[#d4af37] focus:ring-1 focus:ring-[#d4af37] outline-none transition-all"
                placeholder="e.g. Tiger Woods"
                autoFocus
              />
            </div>

            {/* Handicap Input */}
            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <label className="flex items-center gap-2 text-sm font-bold text-[#0d2818]" htmlFor="handicap">
                  <span className="material-symbols-outlined text-[18px] text-[#d4af37]">golf_course</span>
                  Current Handicap <span className="text-slate-400 font-normal">(Optional)</span>
                </label>
                <span className="text-xs text-slate-400 font-medium bg-slate-100 px-2 py-0.5 rounded">GHIN or Est.</span>
              </div>
              <input 
                id="handicap"
                type="number"
                step="0.1"
                value={handicap}
                onChange={(e) => setHandicap(e.target.value)}
                className="w-full h-12 px-4 rounded-lg bg-[#f6f8f6] border border-slate-200 text-[#0d2818] font-medium placeholder:text-slate-400 focus:border-[#d4af37] focus:ring-1 focus:ring-[#d4af37] outline-none transition-all"
                placeholder="e.g. 12.5"
              />
            </div>

            {/* Save Button */}
            <div className="pt-4">
              <button 
                type="submit" 
                disabled={loading}
                className="w-full h-12 bg-[#1a3c26] hover:bg-[#122a1b] text-white font-bold rounded-lg shadow-lg shadow-[#1a3c26]/20 transition-all flex items-center justify-center gap-2 group disabled:opacity-50"
              >
                <span>{loading ? 'Saving...' : 'Save & Continue to Trip'}</span>
                {!loading && <span className="material-symbols-outlined group-hover:translate-x-1 transition-transform text-sm">arrow_forward</span>}
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="components/WeatherWidget.tsx">
'use client'

import { useState, useEffect } from 'react'
import { createClient } from '@supabase/supabase-js'
import { formatTime } from '@/utils/format'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

interface RoundWeather {
  round_id: string
  course_name: string
  date: string
  tee_time: string
  temp: number | null
  description: string
  icon: string
  pop: number
  wind_speed: number
  is_too_far: boolean
}

interface Props {
  tripId: string
}

export default function WeatherWidget({ tripId }: Props) {
  const [forecasts, setForecasts] = useState<RoundWeather[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    fetchRoundWeather()
  }, [tripId])

  const fetchRoundWeather = async () => {
    const apiKey = process.env.NEXT_PUBLIC_OPENWEATHER_API_KEY
    if (!apiKey) return setLoading(false)

    // 1. Get Rounds + Course Location
    const { data: rounds } = await supabase
      .from('rounds')
      .select(`
        id, round_date, tee_time,
        course:courses (name, city, zip_code)
      `)
      .eq('trip_id', tripId)
      .order('round_date', { ascending: true })
      .order('tee_time', { ascending: true })

    if (!rounds || rounds.length === 0) {
      setLoading(false)
      return
    }

    const weatherPromises = rounds.map(async (round: any) => {
      const course = round.course
      const roundDate = round.round_date
      
      const result: RoundWeather = {
        round_id: round.id,
        course_name: course?.name || 'Unknown Course',
        date: roundDate,
        tee_time: round.tee_time,
        temp: null,
        description: '',
        icon: '',
        pop: 0,
        wind_speed: 0,
        is_too_far: false
      }

      if (!course || (!course.city && !course.zip_code)) return result

      const query = course.zip_code ? `${course.zip_code},us` : course.city
      
      try {
        const res = await fetch(
          `https://api.openweathermap.org/data/2.5/forecast?q=${query}&units=imperial&appid=${apiKey}`
        )
        const data = await res.json()

        if (data.cod !== '200') return result

        // Find match closest to Tee Time
        const targetDateTime = new Date(`${roundDate}T${round.tee_time || '12:00:00'}`).getTime()
        
        let closestBlock: any = null
        let minDiff = Infinity

        data.list.forEach((item: any) => {
          const itemTime = new Date(item.dt * 1000).getTime()
          const diff = Math.abs(targetDateTime - itemTime)
          const itemDateString = item.dt_txt.split(' ')[0]
          
          if (itemDateString === roundDate) {
             if (diff < minDiff) {
               minDiff = diff
               closestBlock = item
             }
          }
        })

        if (closestBlock) {
          result.temp = Math.round(closestBlock.main.temp)
          result.description = closestBlock.weather[0].main
          result.icon = closestBlock.weather[0].icon
          result.pop = closestBlock.pop
          result.wind_speed = Math.round(closestBlock.wind.speed)
        } else {
          const today = new Date().toISOString().split('T')[0]
          if (roundDate > today) result.is_too_far = true
        }

      } catch (err) {
        console.error('Weather fetch error', err)
      }

      return result
    })

    const results = await Promise.all(weatherPromises)
    setForecasts(results)
    setLoading(false)
  }

  // Helper to render date LOCALLY (avoids UTC shift to previous day)
  const renderDate = (dateStr: string) => {
    if (!dateStr) return ''
    const [y, m, d] = dateStr.split('-').map(Number)
    const date = new Date(y, m - 1, d)
    return date.toLocaleDateString(undefined, {weekday: 'short'})
  }

  if (loading) return <div style={containerStyle}>Checking forecast...</div>
  if (forecasts.length === 0) return null

  return (
    <div style={containerStyle}>
      <h3 style={headerStyle}>⛳️ Round Forecast</h3>
      <div style={gridStyle}>
        {forecasts.map((item) => (
          <div key={item.round_id} style={cardStyle}>
            <div style={courseHeader}>{item.course_name}</div>
            <div style={subHeader}>
              {renderDate(item.date)} • {formatTime(item.tee_time)}
            </div>

            {item.temp !== null ? (
              <div style={weatherRow}>
                <img 
                  src={`https://openweathermap.org/img/wn/${item.icon}.png`} 
                  alt={item.description}
                  style={{width: '40px', height: '40px'}} 
                />
                <div style={tempStyle}>{item.temp}°</div>
                <div style={statsCol}>
                  {item.pop > 0.2 && <div style={{color: '#2563eb', fontSize: '0.75rem'}}>💧 {Math.round(item.pop * 100)}%</div>}
                  {item.wind_speed > 10 && <div style={{color: '#d97706', fontSize: '0.75rem'}}>💨 {item.wind_speed} mph</div>}
                </div>
              </div>
            ) : (
              <div style={emptyState}>
                {item.is_too_far ? 'Forecast not yet available' : 'No Data'}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  )
}

// Styles
const containerStyle: React.CSSProperties = { backgroundColor: 'white', padding: '20px', borderRadius: '12px', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', marginBottom: '20px', border: '1px solid #e5e7eb' }
const headerStyle: React.CSSProperties = { marginTop: 0, marginBottom: '15px', color: '#111827', fontSize: '1.1rem' }
const gridStyle: React.CSSProperties = { display: 'flex', gap: '15px', overflowX: 'auto', paddingBottom: '10px' }
const cardStyle: React.CSSProperties = { 
  minWidth: '180px', padding: '12px', borderRadius: '8px', 
  border: '1px solid #e5e7eb', backgroundColor: '#f9fafb',
  display: 'flex', flexDirection: 'column', justifyContent: 'center'
}
const courseHeader: React.CSSProperties = { fontWeight: 'bold', fontSize: '0.9rem', color: '#111827', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '160px' }
const subHeader: React.CSSProperties = { fontSize: '0.8rem', color: '#6b7280', marginBottom: '8px' }
const weatherRow: React.CSSProperties = { display: 'flex', alignItems: 'center', gap: '8px' }
const tempStyle: React.CSSProperties = { fontSize: '1.4rem', fontWeight: 'bold', color: '#111827' }
const statsCol: React.CSSProperties = { display: 'flex', flexDirection: 'column', gap: '2px' }
const emptyState: React.CSSProperties = { fontSize: '0.8rem', color: '#9ca3af', fontStyle: 'italic', marginTop: '10px' }
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="utils/supabase/serverClient.ts">
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // 1. Get the user from the secure cookie
  const {
    data: { user },
  } = await supabase.auth.getUser()

  // 2. Define Protected Routes (Dashboard, Trip Pages, etc.)
  //    If user is NOT logged in and tries to go here -> Kick to Landing Page
  if (request.nextUrl.pathname.startsWith('/dashboard') && !user) {
    return NextResponse.redirect(new URL('/', request.url))
  }

  // 3. Define Public Routes (Landing Page)
  //    If user IS logged in and tries to go to Landing Page -> Kick to Dashboard
  if (request.nextUrl.pathname === '/' && user) {
    return NextResponse.redirect(new URL('/dashboard', request.url))
  }

  return response
}
</file>

<file path="utils/format.ts">
export const formatTime = (timeStr: string | null) => {
  if (!timeStr) return ''
  
  // Handle Postgres Time (e.g., "14:30:00")
  if (timeStr.includes(':') && !timeStr.includes('T')) {
    const [hours, minutes] = timeStr.split(':')
    const date = new Date()
    date.setHours(parseInt(hours), parseInt(minutes))
    return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })
  }

  // Handle ISO Timestamp
  const date = new Date(timeStr)
  return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })
}

export const formatTripDates = (start: string, end: string) => {
  if (!start || !end) return ''
  
  // Helper to parse "YYYY-MM-DD" as LOCAL time
  const parseLocal = (s: string) => {
    const [y, m, d] = s.split('-').map(Number)
    return new Date(y, m - 1, d)
  }

  const s = parseLocal(start)
  const e = parseLocal(end)

  const options: Intl.DateTimeFormatOptions = { month: 'short', day: 'numeric' }

  // 1. Same Year? (e.g. "Feb 27 – Mar 9, 2026")
  if (s.getFullYear() === e.getFullYear()) {
    return `${s.toLocaleDateString('en-US', options)} – ${e.toLocaleDateString('en-US', options)}, ${s.getFullYear()}`
  }

  // 2. Different Years? (e.g. "Dec 28, 2025 – Jan 4, 2026")
  return `${s.toLocaleDateString('en-US', { ...options, year: 'numeric' })} – ${e.toLocaleDateString('en-US', { ...options, year: 'numeric' })}`
}

// NEW: Friendly Single Date (e.g. "Fri, Feb 27")
export const formatSingleDate = (dateStr: string) => {
  if (!dateStr) return ''
  // Use .split('T')[0] to ensure we only grab the date part YYYY-MM-DD
  const [y, m, d] = dateStr.split('T')[0].split('-').map(Number)
  const date = new Date(y, m - 1, d)
  return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
}
</file>

<file path=".firebaserc">
{
  "projects": {
    "default": "golf-trip-mvp-d7f07"
  }
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="firebase.json">
{
  "hosting": {
    "public": "out",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}
</file>

<file path="middleware.ts">
import { type NextRequest } from 'next/server'
import { updateSession } from '@/utils/supabase/serverClient'

export async function middleware(request: NextRequest) {
  return await updateSession(request)
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - images (public images folder if you have one)
     * Feel free to modify this pattern to include more paths.
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
</file>

<file path="next.config.ts">
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  images: {
    unoptimized: true, // Required for static export to work with images
  },
};

export default nextConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="app/dashboard/page.tsx">
'use client'

import { useEffect, useState, useRef, Suspense } from 'react' // <--- Added Suspense
import { createBrowserClient } from '@supabase/ssr'
import { useRouter, useSearchParams } from 'next/navigation'
import Link from 'next/link'
import DatePicker from 'react-datepicker'
import "react-datepicker/dist/react-datepicker.css"
import OnboardingModal from '@/components/OnboardingModal'

interface Trip {
  id: string
  trip_name: string
  start_date: string
  end_date: string
  owner_id: string 
}

// 1. RENAME the main function to 'DashboardContent'
function DashboardContent() {
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

  const router = useRouter()
  const searchParams = useSearchParams()
  
  // Data State
  const [trips, setTrips] = useState<Trip[]>([])
  const [loading, setLoading] = useState(true)
  const [debugStatus, setDebugStatus] = useState('Initializing...') 
  const [user, setUser] = useState<any>(null)
  
  // UI State
  const [showOnboarding, setShowOnboarding] = useState(false)
  const [showNewTripModal, setShowNewTripModal] = useState(false)
  const [newTripName, setNewTripName] = useState('')
  const [newTripDates, setNewTripDates] = useState<[Date | null, Date | null]>([null, null])
  const [startDate, endDate] = newTripDates
  const [creating, setCreating] = useState(false)

  // Ref to prevent double-firing
  const processingRef = useRef(false)

  useEffect(() => {
    let mounted = true

    const init = async () => {
      try {
        setDebugStatus('Checking Session...')
        const { data: { session }, error } = await supabase.auth.getSession()
        
        if (error || !session) {
          if (mounted) {
            setDebugStatus('No session found. Redirecting...')
            router.replace('/')
          }
          return
        }

        if (!mounted) return
        setUser(session.user)

        setDebugStatus('Checking Profile...')
        const { data: profile } = await supabase
          .from('profiles')
          .select('full_name')
          .eq('id', session.user.id)
          .single()

        if (!profile || !profile.full_name) {
          setDebugStatus('Profile incomplete. Starting onboarding...')
          setShowOnboarding(true)
          setLoading(false)
          return 
        }

        await handleRoutingLogic(session.user.id)

      } catch (err: any) {
        console.error('Dashboard Error:', err)
        if (mounted) setDebugStatus(`Error: ${err.message}`)
      }
    }

    init()

    return () => { mounted = false }
  }, []) 

  const handleRoutingLogic = async (userId: string) => {
    const tripNameParam = searchParams.get('tripName')
    
    if (tripNameParam && !processingRef.current) {
      processingRef.current = true
      setDebugStatus(`Creating Trip: ${tripNameParam}...`)
      await createTripFromUrl(userId, tripNameParam)
    } else {
      setDebugStatus('Fetching Trips...')
      await fetchTrips(userId)
      setLoading(false)
    }
  }

  const createTripFromUrl = async (userId: string, name: string) => {
    try {
      const start = searchParams.get('start')
      const end = searchParams.get('end')

      console.log("Processing Magic Trip:", name)

      const { data: newTrip, error: tripError } = await supabase.from('trips').insert({
          owner_id: userId,
          trip_name: decodeURIComponent(name),
          start_date: start || null, 
          end_date: end || null
        }).select().single()

      if (tripError) throw tripError

      if (newTrip) {
        await addOwnerToRoster(userId, newTrip.id)
      }

      if (typeof window !== 'undefined') {
        window.history.replaceState(null, '', '/dashboard')
      }

      await fetchTrips(userId)

    } catch (error) {
      console.error('Magic Link Error:', error)
      await fetchTrips(userId)
    } finally {
      setLoading(false)
    }
  }

  const fetchTrips = async (userId: string) => {
    try {
      const { data: ownedTrips } = await supabase.from('trips').select('*').eq('owner_id', userId)
      const { data: memberTripsData } = await supabase.from('trip_golfers').select('trip_id, trips(*)').eq('user_id', userId)
      const memberTrips = memberTripsData?.map((item: any) => item.trips) || []

      const allTripsMap = new Map()
      ;(ownedTrips || []).forEach(t => allTripsMap.set(t.id, t))
      ;(memberTrips || []).forEach(t => { if(t) allTripsMap.set(t.id, t) })

      const allTrips = Array.from(allTripsMap.values()).sort((a, b) => 
        new Date(a.start_date || 0).getTime() - new Date(b.start_date || 0).getTime()
      )

      setTrips(allTrips)
    } catch (error) {
      console.error('Fetch Error:', error)
    }
  }

  const handleCreateTrip = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!newTripName || !startDate || !user) return

    setCreating(true)
    try {
      const { data: newTrip, error: tripError } = await supabase.from('trips').insert({
        owner_id: user.id,
        trip_name: newTripName,
        start_date: startDate.toISOString(),
        end_date: endDate ? endDate.toISOString() : null
      }).select().single()

      if (tripError) throw tripError

      if (newTrip) {
        await addOwnerToRoster(user.id, newTrip.id)
        setShowNewTripModal(false)
        setNewTripName('')
        setNewTripDates([null, null])
        fetchTrips(user.id)
      }
    } catch (error: any) {
      alert('Error creating trip: ' + error.message)
    } finally {
      setCreating(false)
    }
  }

  const addOwnerToRoster = async (userId: string, tripId: string) => {
    try {
      const { data: profile } = await supabase.from('profiles').select('full_name, handicap').eq('id', userId).single()
      
      const displayName = profile?.full_name || 'Organizer'
      const displayHcp = profile?.handicap ? Math.round(profile.handicap) : 0 

      await supabase.from('trip_golfers').insert({
        trip_id: tripId,
        user_id: userId,
        name: displayName,
        handicap: displayHcp
      })
    } catch (err) {
      console.error("Roster Add Failed:", err)
    }
  }

  const formatTripDates = (startStr: string, endStr?: string) => {
    if (!startStr) return 'Date TBD'
    const start = new Date(startStr)
    const startMonth = start.toLocaleDateString('en-US', { month: 'short' })
    const startDay = start.getDate()
    const startYear = start.getFullYear()
    
    if (!endStr) return `${startMonth} ${startDay}, ${startYear}`
    
    const end = new Date(endStr)
    const endMonth = end.toLocaleDateString('en-US', { month: 'short' })
    const endDay = end.getDate()
    const endYear = end.getFullYear()

    if (startYear === endYear) {
      if (startMonth === endMonth) return `${startMonth} ${startDay} - ${endDay}, ${startYear}`
      return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${startYear}`
    }
    return `${startMonth} ${startDay}, ${startYear} - ${endMonth} ${endDay}, ${endYear}`
  }

  const handleOnboardingComplete = async () => {
    setShowOnboarding(false)
    setLoading(true)
    if (user) {
      await handleRoutingLogic(user.id)
    }
  }

  return (
    <div className="min-h-screen bg-[#f9fbf9] font-sans text-[#111814]">
      {/* DatePicker Styles */}
      <style jsx global>{`
        .react-datepicker-wrapper { width: 100%; }
        .react-datepicker__input-container input { width: 100%; background: transparent; border: none; padding: 12px; font-size: 1rem; color: #0d2818; outline: none; }
        .react-datepicker__header { background-color: #f9fbf9; border-bottom: 1px solid #e5e7eb; }
        .react-datepicker__day--selected { background-color: #1a4d2e !important; color: white !important; }
        .react-datepicker__day:hover { background-color: #e5c558 !important; color: black !important; }
        .react-datepicker-popper { z-index: 9999 !important; }
      `}</style>

      {/* --- HEADER --- */}
      <header className="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between sticky top-0 z-10">
        <div className="flex items-center gap-2">
           <div className="text-[#D4AF37] flex items-center justify-center p-1 rounded-full bg-[#0d2818]/5">
              <span className="material-symbols-outlined text-2xl">sports_golf</span>
            </div>
          <h1 className="text-2xl font-bold text-[#0d2818]">My Trips</h1>
        </div>
        <div className="flex items-center gap-4">
          <button onClick={() => supabase.auth.signOut().then(() => router.push('/'))} className="text-sm font-medium text-gray-500 hover:text-[#1a4d2e] transition-colors">Sign Out</button>
        </div>
      </header>

      <main className="p-8 max-w-7xl mx-auto">
        <p className="text-gray-500 mb-8">Manage your upcoming golf getaways</p>

        {loading ? (
          <div className="flex flex-col items-center justify-center py-20 gap-4">
            <div className="w-8 h-8 border-4 border-[#1a4d2e] border-t-transparent rounded-full animate-spin"></div>
            <p className="text-sm text-gray-400 font-mono">{debugStatus}</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            
            {/* 1. ADD CARD */}
            <button 
              onClick={() => setShowNewTripModal(true)} 
              className="bg-slate-50 rounded-2xl border-2 border-dashed border-slate-300 p-8 flex flex-col items-center justify-center text-center hover:border-[#1a4d2e] hover:bg-slate-100 transition-all group min-h-[300px]"
            >
              <div className="w-20 h-20 rounded-full bg-white border-2 border-slate-200 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform shadow-sm">
                <span className="material-symbols-outlined text-slate-400 group-hover:text-[#1a4d2e] text-4xl">add</span>
              </div>
              <h3 className="text-xl font-bold text-slate-500 group-hover:text-[#1a4d2e] transition-colors">Plan New Trip</h3>
              <p className="text-sm text-slate-400 mt-2 max-w-[200px]">Create a new itinerary, invite friends, and track scores.</p>
            </button>

            {/* 2. EXISTING TRIPS */}
            {trips.map(trip => (
              <Link key={trip.id} href={`/trip?id=${trip.id}`}>
                <div className="group bg-white border border-gray-200 rounded-2xl p-8 hover:border-[#d4af37] hover:shadow-md transition-all cursor-pointer relative overflow-hidden h-full flex flex-col justify-between min-h-[300px]">
                  <div>
                    <div className="flex justify-between items-start mb-6">
                      <div className="p-3 rounded-full bg-[#1a4d2e]/5 text-[#1a4d2e]">
                        <span className="material-symbols-outlined text-3xl">travel_explore</span>
                      </div>
                      {trip.owner_id === user?.id && (
                        <span className="bg-[#d4af37]/10 text-[#d4af37] text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">Organizer</span>
                      )}
                    </div>
                    <h3 className="text-2xl font-bold text-[#0d2818] mb-2 group-hover:text-[#1a4d2e] transition-colors line-clamp-2">{trip.trip_name}</h3>
                    <div className="flex items-center gap-2 text-sm text-gray-500 mb-8">
                      <span className="material-symbols-outlined text-sm">calendar_month</span>
                      <span className="font-medium">{formatTripDates(trip.start_date, trip.end_date)}</span>
                    </div>
                  </div>
                  <div className="flex items-center justify-between pt-4 border-t border-gray-100 mt-auto">
                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider group-hover:text-[#1a4d2e] transition-colors">View Details</span>
                    <span className="material-symbols-outlined text-gray-300 group-hover:translate-x-1 transition-transform group-hover:text-[#1a4d2e]">arrow_forward</span>
                  </div>
                </div>
              </Link>
            ))}
          </div>
        )}
      </main>

      {/* --- NEW TRIP MODAL --- */}
      {showNewTripModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={() => setShowNewTripModal(false)}></div>
          <div className="relative w-full max-w-md bg-white rounded-2xl shadow-xl animate-[fadeInUp_0.2s_ease-out]">
            <div className="p-6 border-b border-gray-100"><h3 className="text-xl font-bold text-[#0d2818]">Plan New Trip</h3></div>
            <div className="p-6">
              <form onSubmit={handleCreateTrip} className="flex flex-col gap-5">
                <div className="flex flex-col gap-2">
                  <label className="text-xs font-bold uppercase text-gray-500">Trip Name</label>
                  <input autoFocus value={newTripName} onChange={e => setNewTripName(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="e.g. Bandon Dunes 2026" required />
                </div>
                <div className="flex flex-col gap-2">
                  <label className="text-xs font-bold uppercase text-gray-500">Dates</label>
                  <div className="border border-gray-200 rounded-lg p-1 bg-white focus-within:ring-2 focus-within:ring-[#1a4d2e]">
                    <DatePicker selectsRange={true} startDate={startDate} endDate={endDate} onChange={(update) => setNewTripDates(update)} className="w-full p-2 outline-none" placeholderText="Select Date Range" required popperPlacement="bottom-start" />
                  </div>
                </div>
                <div className="flex gap-2 mt-4 pt-4 border-t border-gray-100">
                  <button type="button" onClick={() => setShowNewTripModal(false)} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-lg">Cancel</button>
                  <button type="submit" disabled={creating} className="flex-1 py-3 bg-[#1a4d2e] text-white font-bold rounded-lg hover:bg-[#143a22] disabled:opacity-50">{creating ? 'Creating...' : 'Create Trip'}</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* --- ONBOARDING MODAL --- */}
      {showOnboarding && user && (
        <OnboardingModal userId={user.id} onComplete={handleOnboardingComplete} />
      )}
    </div>
  )
}

// 2. CREATE A NEW DEFAULT EXPORT WRAPPED IN SUSPENSE
export default function Dashboard() {
  return (
    <Suspense fallback={<div className="h-screen flex items-center justify-center bg-[#f9fbf9]"><div className="w-8 h-8 border-4 border-[#1a4d2e] border-t-transparent rounded-full animate-spin"></div></div>}>
      <DashboardContent />
    </Suspense>
  )
}
</file>

<file path="app/trip/page.tsx">
'use client'

import { useEffect, useState, Suspense } from 'react' // <--- Added Suspense
import { createBrowserClient } from '@supabase/ssr' 
import { useRouter, useSearchParams } from 'next/navigation'
import Link from 'next/link'
import { Trip, Golfer, Round, Lodging, Dining, Expense, RoundWeather } from './types'

// Components
import TripRoster from './components/TripRoster'
import TripGolf from './components/TripGolf'
import TripFlights from './components/TripFlights'
import TripLodging from './components/TripLodging'
import TripDining from './components/TripDining'
import TripExpenses from './components/TripExpenses'

const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

// 1. RENAME to TripPageContent
function TripPageContent() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const tripId = searchParams.get('id')

  // Data State
  const [trip, setTrip] = useState<Trip | null>(null)
  const [golfers, setGolfers] = useState<Golfer[]>([])
  const [rounds, setRounds] = useState<Round[]>([])
  const [lodgings, setLodgings] = useState<Lodging[]>([])
  const [dinings, setDinings] = useState<Dining[]>([])
  const [expenses, setExpenses] = useState<Expense[]>([])
  
  // UI State
  const [weatherMap, setWeatherMap] = useState<Record<string, RoundWeather>>({})
  const [loading, setLoading] = useState(true)
  const [activeTab, setActiveTab] = useState('Roster') 

  useEffect(() => {
    if (!tripId) return
    
    const init = async () => {
      const { data: tripData, error } = await supabase.from('trips').select('*').eq('id', tripId).single()
      
      if (error) console.error("Error fetching trip:", error)
      if (tripData) {
        setTrip(tripData)
        await checkAndFixRoster(tripData)
      }

      await refreshAll()
      setLoading(false)
    }
    init()
  }, [tripId])

  const checkAndFixRoster = async (tripData: Trip) => {
    const { data: { user } } = await supabase.auth.getUser()
    if (!user || user.id !== tripData.owner_id) return

    const { data: existingEntry } = await supabase
      .from('trip_golfers')
      .select('id')
      .eq('trip_id', tripData.id)
      .eq('user_id', user.id)
      .single()

    if (!existingEntry) {
      console.log("Owner missing from roster. Auto-fixing...")
      
      const { data: profile } = await supabase.from('profiles').select('full_name, handicap').eq('id', user.id).single()
      
      await supabase.from('trip_golfers').insert({
        trip_id: tripData.id,
        user_id: user.id,
        name: profile?.full_name || 'Organizer',
        handicap: profile?.handicap ? Math.round(profile.handicap) : 0
      })
      
      fetchRoster()
    }
  }

  const refreshAll = async () => {
    await Promise.all([fetchRoster(), fetchRounds(), fetchLodging(), fetchDining(), fetchExpenses()])
  }

  const fetchRoster = async () => {
    if (!tripId) return
    const { data: rosterData } = await supabase.from('trip_golfers').select(`*, flights:golfer_flights(*)`).eq('trip_id', tripId)
    if (!rosterData) return

    const userIds = rosterData.map(g => g.user_id).filter(uid => uid !== null)
    let profilesMap: Record<string, string> = {}

    if (userIds.length > 0) {
      const { data: profiles } = await supabase.from('profiles').select('id, full_name').in('id', userIds)
      if (profiles) profiles.forEach(p => profilesMap[p.id] = p.full_name)
    }

    setGolfers(rosterData.map(g => ({ ...g, profile_name: g.user_id ? profilesMap[g.user_id] : undefined })) as any)
  }

  const fetchRounds = async () => {
    if (!tripId) return
    const { data } = await supabase.from('rounds').select(`*, courses ( id, name, address, city, state, zip_code ), round_players ( trip_golfers ( id, name, handicap ) )`).eq('trip_id', tripId).order('round_date', { ascending: true }).order('tee_time', { ascending: true })
    if (data) {
      const roundsData = data as any
      setRounds(roundsData)
      fetchWeather(roundsData)
    }
  }

  const fetchLodging = async () => {
    if (!tripId) return
    const { data } = await supabase.from('trip_lodging').select('*').eq('trip_id', tripId).order('check_in_time', { ascending: true })
    if (data) setLodgings(data as any)
  }

  const fetchDining = async () => {
    if (!tripId) return
    const { data } = await supabase.from('trip_dining').select('*').eq('trip_id', tripId).order('reservation_time', { ascending: true })
    if (data) setDinings(data as any)
  }

  const fetchExpenses = async () => {
    if (!tripId) return
    const { data } = await supabase.from('trip_expenses').select('*').eq('trip_id', tripId).order('expense_date', { ascending: false })
    if (data) setExpenses(data as any)
  }

  const fetchWeather = async (roundsData: Round[]) => {
    const apiKey = process.env.NEXT_PUBLIC_OPENWEATHER_API_KEY
    if (!apiKey) return 

    const newWeatherMap: Record<string, RoundWeather> = {}

    await Promise.all(roundsData.map(async (round) => {
      if (!round.courses?.city || !round.courses?.state || !round.round_date) return

      try {
        const geoUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${round.courses.city},${round.courses.state},US&limit=1&appid=${apiKey}`
        const geoRes = await fetch(geoUrl)
        const geoData = await geoRes.json()

        if (!geoData || geoData.length === 0) return

        const { lat, lon } = geoData[0]
        const weatherUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=imperial&appid=${apiKey}`
        const weatherRes = await fetch(weatherUrl)
        const weatherData = await weatherRes.json()

        if (!weatherData.list) return

        const targetDate = round.round_date 
        const dayForecasts = weatherData.list.filter((item: any) => item.dt_txt.startsWith(targetDate))

        if (dayForecasts.length > 0) {
          const bestMatch = dayForecasts[Math.floor(dayForecasts.length / 2)]
          newWeatherMap[round.id] = {
            temp: Math.round(bestMatch.main.temp),
            description: bestMatch.weather[0].main, 
            icon: bestMatch.weather[0].icon,        
            wind_speed: Math.round(bestMatch.wind.speed),
            pop: Math.round(bestMatch.pop * 100)    
          }
        }
      } catch (err) {
        console.error("Weather fetch failed", err)
      }
    }))

    setWeatherMap(newWeatherMap)
  }

  const formatDateRange = (startStr?: string, endStr?: string) => {
    if (!startStr) return 'Date TBD'
    
    const parseLocal = (s: string) => {
      const [y, m, d] = s.split('-').map(Number)
      return new Date(y, m - 1, d)
    }

    const start = parseLocal(startStr)
    const end = endStr ? parseLocal(endStr) : null

    const startMonth = start.toLocaleString('en-US', { month: 'short' })
    const startDay = start.getDate()
    const year = start.getFullYear()

    if (!end) return `${startMonth} ${startDay}, ${year}`

    const endMonth = end.toLocaleString('en-US', { month: 'short' })
    const endDay = end.getDate()
    const endYear = end.getFullYear()

    if (startMonth === endMonth && year === endYear) return `${startMonth} ${startDay} - ${endDay}, ${year}`
    if (year === endYear) return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`
    return `${startMonth} ${startDay}, ${year} - ${endMonth} ${endDay}, ${endYear}`
  }

  if (loading) return <div className="h-screen flex items-center justify-center bg-[#f8f8f5]"><div className="w-8 h-8 border-4 border-[#1a4d2e] border-t-transparent rounded-full animate-spin"></div></div>

  return (
    <div className="flex h-screen overflow-hidden font-sans bg-[#f8f8f5] text-[#221f10]">
      {/* Sidebar */}
      <aside className="w-64 flex-shrink-0 bg-white border-r border-slate-200 flex flex-col justify-between z-20">
        <div className="p-6">
          <Link href="/dashboard" className="flex items-center gap-2 text-slate-500 hover:text-[#1a4d2e] mb-6 transition-colors group">
            <span className="material-symbols-outlined text-lg group-hover:-translate-x-1 transition-transform">arrow_back</span>
            <span className="text-xs font-bold uppercase tracking-wider">Back to Trips</span>
          </Link>
          <div className="flex items-center gap-3 mb-8">
            <div className="w-10 h-10 rounded-full bg-[#1a4d2e] text-[#f2d00d] flex items-center justify-center shadow-md shrink-0"><span className="material-symbols-outlined">sports_golf</span></div>
            <div>
              <h1 className="text-slate-900 font-bold text-sm leading-tight line-clamp-2">{trip?.trip_name || 'Loading Trip...'}</h1>
              <p className="text-slate-500 text-xs font-medium mt-0.5">
                {formatDateRange(trip?.start_date, trip?.end_date)}
              </p>
            </div>
          </div>
          <nav className="flex flex-col gap-1">
            {['Roster', 'Golf', 'Flight', 'Lodging', 'Dining', 'Expenses'].map(tab => (
              <button key={tab} onClick={() => setActiveTab(tab)} className={`flex items-center gap-3 px-3 py-2.5 rounded-lg w-full text-left transition-colors ${activeTab === tab ? 'bg-[#f2d00d]/20 text-[#1a4d2e] font-bold' : 'text-slate-600 hover:bg-slate-50 font-medium'}`}>
                <span className="material-symbols-outlined text-[20px]">{getIcon(tab)}</span><span className="text-sm">{tab === 'Flight' ? 'Flight Info' : tab}</span>
              </button>
            ))}
          </nav>
        </div>
        <div className="p-4 border-t border-slate-100">
          <button className="flex items-center gap-3 w-full p-2 hover:bg-slate-50 rounded-lg transition-colors">
            <div className="w-9 h-9 rounded-full bg-[#1a4d2e]/10 flex items-center justify-center text-[#1a4d2e] font-bold text-xs">ME</div>
            <div className="text-left"><p className="text-sm font-bold text-slate-900">My Profile</p><p className="text-xs text-slate-500">View Settings</p></div>
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 overflow-y-auto bg-[#f8f8f5]">
        {activeTab === 'Roster' && <TripRoster tripId={tripId!} golfers={golfers} tripOwnerId={trip?.owner_id} onUpdate={fetchRoster} />}
        {activeTab === 'Golf' && <TripGolf tripId={tripId!} rounds={rounds} golfers={golfers} weatherMap={weatherMap} onUpdate={fetchRounds} />}
        {activeTab === 'Flight' && <TripFlights tripId={tripId!} golfers={golfers} onUpdate={fetchRoster} />}
        {activeTab === 'Lodging' && <TripLodging tripId={tripId!} lodgings={lodgings} trip={trip} onUpdate={fetchLodging} />}
        {activeTab === 'Dining' && <TripDining tripId={tripId!} dinings={dinings} onUpdate={fetchDining} />}
        {activeTab === 'Expenses' && <TripExpenses tripId={tripId!} expenses={expenses} golfers={golfers} onUpdate={fetchExpenses} />}
      </main>
    </div>
  )
}

function getIcon(tab: string) {
  const map: Record<string, string> = { Roster: 'groups', Golf: 'golf_course', Flight: 'flight', Lodging: 'bed', Dining: 'restaurant', Expenses: 'payments' }
  return map[tab]
}

// 2. EXPORT THE WRAPPER
export default function TripPage() {
  return (
    <Suspense fallback={<div className="h-screen flex items-center justify-center bg-[#f8f8f5]"><div className="w-8 h-8 border-4 border-[#1a4d2e] border-t-transparent rounded-full animate-spin"></div></div>}>
      <TripPageContent />
    </Suspense>
  )
}
</file>

<file path="app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

/* This targets the text inside the input before you type */
input::placeholder {
  color: #9ca3af; /* A nice light grey */
  opacity: 1;    /* Ensures the color shows correctly in Firefox */
}

/* ... existing code ... */

/* ADD THIS BLOCK FOR ICONS */
.material-symbols-outlined {
  font-family: 'Material Symbols Outlined';
  font-weight: normal;
  font-style: normal;
  font-size: 24px;  /* Default size */
  display: inline-block;
  line-height: 1;
  text-transform: none;
  letter-spacing: normal;
  word-wrap: normal;
  white-space: nowrap;
  direction: ltr;
  /* Support for all WebKit browsers. */
  -webkit-font-smoothing: antialiased;
  /* Support for Safari and Chrome. */
  text-rendering: optimizeLegibility;
  /* Support for Firefox. */
  -moz-osx-font-smoothing: grayscale;
}
</file>

<file path="app/layout.tsx">
import './globals.css'
import type { Metadata } from 'next'
import { Plus_Jakarta_Sans } from 'next/font/google'

const jakarta = Plus_Jakarta_Sans({ 
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-jakarta',
})

export const metadata: Metadata = {
  title: 'GolfTripHQ', // <--- UPDATED
  description: 'The easiest way to organize your golf trip.',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en" className={jakarta.variable}>
      <head>
        {/* GLOBAL ICON LOADER: This makes "person", "golf_course", etc. turn into icons */}
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
      </head>
      <body className="font-sans antialiased bg-[#f9fbf9] text-[#111814]">
        {children}
      </body>
    </html>
  )
}
</file>

<file path="package.json">
{
  "name": "golf-trip-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.93.3",
    "@types/react-datepicker": "^6.2.0",
    "next": "16.1.6",
    "react": "19.2.3",
    "react-datepicker": "^9.1.0",
    "react-dom": "19.2.3",
    "resend": "^6.9.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.6",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="README.md">
# GolfTripHQ

This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="app/trip/components/TripRoster.tsx">
'use client'

import { useState } from 'react'
import { createBrowserClient } from '@supabase/ssr'
import { Golfer } from '../types'

export default function TripRoster({ 
  tripId, 
  golfers, 
  tripOwnerId, 
  tripName, 
  onUpdate 
}: { 
  tripId: string, 
  golfers: Golfer[], 
  tripOwnerId?: string, 
  tripName?: string, 
  onUpdate: () => void 
}) {
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

  const [showAddModal, setShowAddModal] = useState(false)
  const [showInviteModal, setShowInviteModal] = useState(false)
  const [newName, setNewName] = useState('')
  const [newHcp, setNewHcp] = useState('')
  const [inviteId, setInviteId] = useState<string | null>(null)
  const [inviteEmail, setInviteEmail] = useState('')
  const [sending, setSending] = useState(false)

  const handleAddGolfer = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!newName || !tripId) return

    const { error } = await supabase.from('trip_golfers').insert({
      trip_id: tripId, 
      name: newName, 
      handicap: newHcp ? parseFloat(newHcp) : 0 
    })

    if (error) {
      alert(`Failed to add golfer: ${error.message}`)
    } else {
      setNewName('')
      setNewHcp('')
      setShowAddModal(false)
      onUpdate()
    }
  }

  const handleOpenInvite = (golferId: string) => {
    setInviteId(golferId)
    setInviteEmail('')
    setShowInviteModal(true)
  }

  const handleInvite = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!inviteId || !inviteEmail) return
    
    setSending(true)

    try {
      const response = await fetch('/api/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: inviteEmail,
          tripId: tripId,
          golferId: inviteId,
          name: golfers.find(g => g.id === inviteId)?.name || 'Golfer',
          tripName: tripName || 'Golf Trip'
        })
      })

      const result = await response.json()

      if (!response.ok) {
        alert(`Error: ${result.error}`)
      } else {
        setShowInviteModal(false)
        onUpdate()
        alert(`Invite sent to ${inviteEmail}!`)
      }
    } catch (err) {
      alert('Network error sending invite')
    } finally {
      setSending(false)
    }
  }

  const getInitials = (name: string) => name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()

  return (
    <div className="p-8 max-w-7xl mx-auto flex flex-col gap-8 pb-20">
      <div>
        <h2 className="text-2xl font-bold text-slate-900 tracking-tight">Trip Roster</h2>
        <p className="text-sm text-slate-500 mt-1">Manage attendees and handicaps</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {golfers.map((golfer) => {
          const isOrganizer = tripOwnerId && tripOwnerId === golfer.user_id
          const displayName = golfer.profile_name || golfer.name
          
          return (
            <div key={golfer.id} className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col items-center hover:shadow-md transition-shadow group relative">
              <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 border-2 ${isOrganizer ? 'bg-[#1a4d2e]/10 border-[#f2d00d]/20 text-[#1a4d2e]' : 'bg-slate-100 border-slate-200 text-slate-500'}`}>
                <span className="text-2xl font-bold tracking-wide">{getInitials(displayName)}</span>
              </div>
              <h3 className="text-lg font-bold text-slate-900">{displayName}</h3>
              <span className={`text-xs font-semibold uppercase tracking-wider mb-4 ${isOrganizer ? 'text-[#d4b60b]' : 'text-slate-400'}`}>
                {isOrganizer ? 'Organizer' : 'Member'}
              </span>
              <div className="w-full grid grid-cols-2 gap-2 text-center mt-2 pt-4 border-t border-slate-100">
                <div>
                  <p className="text-2xl font-bold text-slate-800">{golfer.handicap}</p>
                  <p className="text-xs text-slate-500 uppercase tracking-wide">HCP</p>
                </div>
                <div className="border-l border-slate-100 flex flex-col items-center justify-center">
                  {golfer.user_id ? ( 
                    <div className="flex flex-col items-center">
                      <span className="material-symbols-outlined text-[#1a4d2e] text-xl">verified</span>
                      <span className="text-[10px] font-bold uppercase tracking-wider text-[#1a4d2e] mt-1">Verified</span>
                    </div>
                  ) : golfer.email ? (
                    <button onClick={() => handleOpenInvite(golfer.id)} className="flex flex-col items-center hover:opacity-75">
                      <span className="material-symbols-outlined text-amber-500 text-xl">schedule</span>
                      <span className="text-[10px] font-bold uppercase tracking-wider text-amber-500 mt-1">Pending</span>
                    </button>
                  ) : (
                    <button onClick={() => handleOpenInvite(golfer.id)} className="flex items-center justify-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-600 text-[10px] font-bold uppercase px-3 py-1.5 rounded-full transition-colors">
                      <span className="material-symbols-outlined text-xs">add</span> Invite
                    </button>
                  )}
                </div>
              </div>
            </div>
          )
        })}

        <button onClick={() => setShowAddModal(true)} className="bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 p-6 flex flex-col items-center justify-center hover:border-[#1a4d2e] hover:bg-slate-100 transition-all group min-h-[280px]">
          <div className="w-16 h-16 rounded-full bg-white border-2 border-slate-200 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
            <span className="material-symbols-outlined text-slate-400 group-hover:text-[#1a4d2e] text-3xl">add</span>
          </div>
          <h3 className="text-lg font-bold text-slate-500 group-hover:text-[#1a4d2e]">Add Golfer</h3>
          <p className="text-sm text-slate-400 mt-2">Invite new participant</p>
        </button>
      </div>

      {showAddModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={() => setShowAddModal(false)}></div>
          <div className="relative w-full max-w-sm bg-white rounded-2xl shadow-xl overflow-hidden animate-[fadeInUp_0.2s_ease-out]">
            <div className="p-6">
              <h3 className="text-xl font-bold text-[#0d2818] mb-4">Add New Golfer</h3>
              <form onSubmit={handleAddGolfer} className="flex flex-col gap-4">
                <div>
                  <label className="text-xs font-bold uppercase text-gray-500 mb-1 block">Name</label>
                  <input autoFocus value={newName} onChange={e => setNewName(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="e.g. Rory McIlroy" />
                </div>
                <div>
                  <label className="text-xs font-bold uppercase text-gray-500 mb-1 block">Handicap</label>
                  <input type="number" step="0.1" value={newHcp} onChange={e => setNewHcp(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="0.0" />
                </div>
                <div className="flex gap-2 mt-4">
                  <button type="button" onClick={() => setShowAddModal(false)} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-lg">Cancel</button>
                  <button type="submit" className="flex-1 py-3 bg-[#1a4d2e] text-white font-bold rounded-lg hover:bg-[#143a22]">Add Golfer</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {showInviteModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={() => setShowInviteModal(false)}></div>
          <div className="relative w-full max-w-sm bg-white rounded-2xl shadow-xl overflow-hidden animate-[fadeInUp_0.2s_ease-out]">
            <div className="p-6">
              <div className="flex items-center gap-3 mb-4">
                <div className="h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><span className="material-symbols-outlined">mail</span></div>
                <h3 className="text-xl font-bold text-[#0d2818]">Invite Golfer</h3>
              </div>
              <p className="text-sm text-slate-500 mb-6">Enter their email. We'll send them a secure magic link to join this trip instantly.</p>
              <form onSubmit={handleInvite} className="flex flex-col gap-4">
                <div>
                  <label className="text-xs font-bold uppercase text-gray-500 mb-1 block">Email Address</label>
                  <input autoFocus type="email" value={inviteEmail} onChange={e => setInviteEmail(e.target.value)} className="w-full border border-gray-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#1a4d2e]" placeholder="golfer@example.com" required />
                </div>
                <div className="flex gap-2 mt-2">
                  <button type="button" onClick={() => setShowInviteModal(false)} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-lg">Cancel</button>
                  <button type="submit" disabled={sending} className="flex-1 py-3 bg-[#1a4d2e] text-white font-bold rounded-lg hover:bg-[#143a22] disabled:opacity-50">
                    {sending ? 'Sending...' : 'Send Invite'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
</file>

<file path="app/api/invite/route.ts">
import { createClient } from '@supabase/supabase-js'
import { NextResponse } from 'next/server'
import { Resend } from 'resend'

const resend = new Resend(process.env.RESEND_API_KEY)

export async function POST(req: Request) {
  const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    { auth: { autoRefreshToken: false, persistSession: false } }
  )

  try {
    const { email, tripId, name, golferId, tripName } = await req.json()

    if (!email || !tripId || !golferId) {
      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })
    }

    // 1. Check if user exists, otherwise create them (silently)
    const { data: { users }, error: listError } = await supabaseAdmin.auth.admin.listUsers()
    const existingUser = users?.find(u => u.email === email)
    
    let userId = existingUser?.id

    if (!existingUser) {
      // Create user with "email_confirm: true" so they can log in immediately
      const { data: newUser, error: createError } = await supabaseAdmin.auth.admin.createUser({
        email: email,
        email_confirm: true,
        user_metadata: { full_name: name }
      })
      
      if (createError) throw createError
      userId = newUser.user.id
    }

    if (!userId) throw new Error("Failed to resolve User ID")

    // 2. Generate a 'magiclink' (Login Link)
    // This type just creates a link for an existing user. It does NOT try to send an email.
    const { data: linkData, error: linkError } = await supabaseAdmin.auth.admin.generateLink({
      type: 'magiclink', 
      email: email,
      options: {
        redirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/trip?id=${tripId}`
      }
    })

    if (linkError) {
      console.error('Link Generation Error:', linkError)
      return NextResponse.json({ error: linkError.message }, { status: 500 })
    }

    const { properties } = linkData
    const action_link = properties?.action_link

    if (!action_link) {
      return NextResponse.json({ error: 'Failed to generate action link' }, { status: 500 })
    }

    // 3. Link Golfer Profile
    const { error: updateError } = await supabaseAdmin
      .from('trip_golfers')
      .update({ user_id: userId, email: email })
      .eq('id', golferId)

    if (updateError) throw updateError

    // 4. Send Email via Resend
    const { error: emailError } = await resend.emails.send({
      from: 'GolfTripHQ <noreply@golftriphq.com>', 
      to: [email],
      subject: `You're invited to ${tripName || 'a Golf Trip'}!`,
      html: `
        <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px;">
          <h1 style="color: #1a4d2e; margin-bottom: 16px;">You're going on a golf trip! ⛳️</h1>
          <p style="font-size: 16px; color: #374151; line-height: 1.5;">
            You have been added to the roster for <strong>${tripName || 'an upcoming trip'}</strong>.
          </p>
          <p style="font-size: 16px; color: #374151; line-height: 1.5; margin-bottom: 24px;">
            Click the button below to accept your invite and view the itinerary.
          </p>
          <a href="${action_link}" style="display: inline-block; background-color: #d4af37; color: #000; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 16px;">
            Join Trip
          </a>
          <p style="color: #6b7280; font-size: 12px; margin-top: 30px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
            If the button doesn't work, copy this link: <br/>
            <a href="${action_link}" style="color: #1a4d2e;">${action_link}</a>
          </p>
        </div>
      `
    })

    if (emailError) {
      console.error('Resend Error:', emailError)
      return NextResponse.json({ error: 'Failed to send email' }, { status: 500 })
    }

    return NextResponse.json({ success: true, message: 'Invite sent via Resend' })

  } catch (err: any) {
    console.error('Server Error:', err)
    return NextResponse.json({ error: err.message }, { status: 500 })
  }
}
</file>

<file path="app/page.tsx">
'use client'

import { useState } from 'react'
import { createBrowserClient } from '@supabase/ssr' // ADD THIS
import DatePicker from 'react-datepicker'
import "react-datepicker/dist/react-datepicker.css"

const supabase = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

export default function LandingPage() {
  
  // --- TRIP CREATION STATE ---
  const [location, setLocation] = useState('')
  const [dateRange, setDateRange] = useState<[Date | null, Date | null]>([null, null]);
  const [startDate, endDate] = dateRange;
  const [email, setEmail] = useState('')
  
  // --- SIGN IN STATE ---
  const [showSignIn, setShowSignIn] = useState(false)
  const [signInEmail, setSignInEmail] = useState('')
  const [signInStep, setSignInStep] = useState(1) // 1 = Input, 2 = Success

  // --- SHARED UI STATE ---
  const [currentStep, setCurrentStep] = useState(1) // 1 = Landing Hero, 2 = Trip Confirm Modal
  const [loading, setLoading] = useState(false)

  // ---------------------------------------------------------
  // ACTION: START PLANNING (Create Trip)
  // ---------------------------------------------------------
  const handleStartPlanning = async (e?: React.FormEvent<HTMLFormElement>) => {
    if (e) e.preventDefault()
    
    if (!location) return alert('Please enter a destination')
    if (!startDate) return alert('Please select dates')
    if (!email) return alert('Please enter your email')
    
    setLoading(true)
    
    // FIX: Construct the URL manually to ensure it handles special characters in location correctly
    // We pass the trip details in the 'next' parameter so the Dashboard can read them immediately
    const nextUrl = `/dashboard?tripName=${encodeURIComponent(location)}&start=${startDate.toISOString()}&end=${endDate ? endDate.toISOString() : ''}`
    const redirectUrl = `${window.location.origin}/auth/callback?next=${encodeURIComponent(nextUrl)}`

    const { error } = await supabase.auth.signInWithOtp({ 
      email,
      options: {
        emailRedirectTo: redirectUrl, // <--- THIS WAS MISSING
        data: {
          location: location,
          start_date: startDate ? startDate.toISOString() : null,
          end_date: endDate ? endDate.toISOString() : null
        }
      }
    })
    
    setLoading(false)

    if (error) {
      alert(error.message)
    } else {
      setCurrentStep(2)
    }
  }

  // ---------------------------------------------------------
  // ACTION: SIGN IN (Existing User)
  // ---------------------------------------------------------
  const handleSignIn = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    if (!signInEmail) return alert('Please enter your email')

    setLoading(true)
    const { error } = await supabase.auth.signInWithOtp({ 
      email: signInEmail,
      options: {
        // FIX: Point existing users to the callback (defaults to /dashboard)
        emailRedirectTo: `${window.location.origin}/auth/callback` 
      }
    })
    setLoading(false)

    if (error) {
      alert(error.message)
    } else {
      setSignInStep(2)
    }
  }

// Resend Logic
  const handleResend = async (targetEmail: string) => {
    setLoading(true)
    
    // capture the error object
    const { error } = await supabase.auth.signInWithOtp({ 
      email: targetEmail,
      options: {
        emailRedirectTo: `${window.location.origin}/auth/callback`
      }
    })
    
    setLoading(false)

    // CHECK for the error before celebrating
    if (error) {
      alert(`Error: ${error.message}`) // This will likely say "Rate limit exceeded"
    } else {
      alert(`Magic link resent to ${targetEmail}`)
    }
  }

  // Edit Email Logic
  const handleEditEmail = () => {
    setCurrentStep(1)
  }

  return (
    <div className="min-h-screen flex flex-col font-sans text-[#111814] bg-[#f9fbf9] overflow-x-hidden">
      <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
      <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

      {/* DatePicker Overrides */}
      <style jsx global>{`
        .react-datepicker-wrapper { width: 100%; }
        .react-datepicker__input-container input {
           width: 100%; background: transparent; border: none;
           padding: 12px 12px 12px 40px; font-size: 1rem; color: #0d2818; outline: none;
        }
        .react-datepicker__input-container input:focus { box-shadow: none; border-color: #d4af37; }
        .react-datepicker__header { background-color: #f9fbf9; border-bottom: 1px solid #e5e7eb; }
        .react-datepicker__day--selected, .react-datepicker__day--in-range {
           background-color: #1a4d2e !important; color: white !important;
        }
        .react-datepicker__day--keyboard-selected {
           background-color: #d4af37 !important; color: black !important;
        }
      `}</style>

      {/* --- HEADER --- */}
      <header className="fixed top-0 z-40 w-full transition-all duration-300 bg-[#0d2818]/90 backdrop-blur-md border-b border-white/10 px-4 py-4 sm:px-10">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="text-[#D4AF37] flex items-center justify-center p-1.5 rounded-full bg-white/5 border border-white/10">
              <span className="material-symbols-outlined text-2xl">sports_golf</span>
            </div>
            <h2 className="text-white text-xl font-bold leading-tight tracking-tight font-display">
              GolfTrip<span className="text-[#D4AF37]">HQ</span>
            </h2>
          </div>
          <div className="flex items-center gap-4">
            <button 
              onClick={() => {
                setShowSignIn(true)
                setSignInStep(1)
              }}
              className="flex items-center gap-2 cursor-pointer rounded-full h-10 px-5 bg-white/10 border border-white/20 text-white text-sm font-bold hover:bg-white/20 hover:border-white/30 transition-all"
            >
              <span className="hidden sm:inline">Sign In</span>
              <span className="material-symbols-outlined text-[18px]">login</span>
            </button>
          </div>
        </div>
      </header>

      <main className="flex-grow flex flex-col items-center w-full relative">
        
        {/* --- HERO SECTION --- */}
        <div 
          className="relative w-full flex flex-col items-center justify-center min-h-screen bg-cover bg-center bg-no-repeat p-4 sm:p-8" 
          style={{ backgroundImage: `linear-gradient(rgba(13, 40, 24, 0.5), rgba(13, 40, 24, 0.7)), url('https://images.unsplash.com/photo-1587174486073-ae5e5cff23aa?q=80&w=2070&auto=format&fit=crop')` }}
        >
          <div className="absolute inset-0 bg-[#0d2818]/30 backdrop-blur-[2px]"></div>
          
          <div className="relative z-10 w-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12 items-center h-full pt-20">
            {/* Left Copy */}
            <div className="flex flex-col gap-6 text-center lg:text-left order-2 lg:order-1">
              <h1 className="text-white text-4xl sm:text-6xl font-black leading-tight tracking-tight drop-shadow-xl font-display">
                Craft Your Ideal <br/> <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#D4AF37] to-[#e5c558]">Golf Getaway</span>
              </h1>
            </div>

            {/* Right Form Panel (Create Trip) */}
            <div id="planning-form" className="order-1 lg:order-2 w-full flex justify-center lg:justify-end">
              <div className="w-full max-w-md rounded-2xl shadow-2xl border-t border-white/40 overflow-hidden relative" style={{ background: 'rgba(255, 255, 255, 0.95)', backdropFilter: 'blur(12px)' }}>
                <div className="h-1.5 w-full bg-gray-200 flex">
                  <div className="w-1/2 h-full bg-[#d4af37]"></div>
                  <div className="w-1/2 h-full bg-transparent"></div>
                </div>
                <div className="p-8 flex flex-col gap-6">
                  <div className="flex items-center justify-between">
                    <h3 className="text-2xl font-bold text-[#0d2818]">Trip Details</h3>
                    <span className="text-xs font-bold text-[#d4af37] uppercase tracking-wider">Step 1 of 2</span>
                  </div>
                  <form onSubmit={handleStartPlanning} className="flex flex-col gap-5">
                    <div className="flex flex-col gap-2">
                      <label className="text-xs font-bold uppercase tracking-wider text-gray-500">Trip Name</label>
                      <div className="relative group">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-[#d4af37]"><span className="material-symbols-outlined">location_on</span></div>
                        <input value={location} onChange={(e) => setLocation(e.target.value)} className="w-full bg-white border border-gray-200 rounded-xl py-3 pl-10 pr-4 text-[#0d2818] placeholder:text-gray-400 focus:ring-2 focus:ring-[#d4af37] focus:border-[#d4af37] transition-all outline-none" placeholder="e.g. Pebble Beach" />
                      </div>
                    </div>
                    <div className="flex flex-col gap-2">
                      <label className="text-xs font-bold uppercase tracking-wider text-gray-500">Dates</label>
                      <div className="relative group">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-[#d4af37] z-10 h-full"><span className="material-symbols-outlined">date_range</span></div>
                        <div className="w-full bg-white border border-gray-200 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-[#d4af37] focus-within:border-[#d4af37] transition-all">
                          <DatePicker selectsRange={true} startDate={startDate} endDate={endDate} onChange={(update) => setDateRange(update)} isClearable={true} placeholderText="Start Date - End Date" className="w-full py-3 pl-10 pr-4 text-[#0d2818] outline-none" dateFormat="MMM d, yyyy" />
                        </div>
                      </div>
                    </div>
                    <div className="flex flex-col gap-2">
                      <label className="text-xs font-bold uppercase tracking-wider text-gray-500">Secure with Magic Link</label>
                      <div className="relative group">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-[#d4af37]"><span className="material-symbols-outlined">mail</span></div>
                        <input value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-white border border-gray-200 rounded-xl py-3 pl-10 pr-4 text-[#0d2818] placeholder:text-gray-400 focus:ring-2 focus:ring-[#d4af37] focus:border-[#d4af37] transition-all outline-none" placeholder="name@email.com" type="email" required />
                      </div>
                    </div>
                    <button type="submit" disabled={loading} className="bg-[#1a4d2e] hover:bg-[#0d2818] text-white p-3 rounded-xl transition-colors flex items-center justify-center shadow-lg shadow-[#1a4d2e]/20 disabled:opacity-50 font-bold text-lg gap-2">
                      {loading ? 'Sending...' : 'Start Planning'}
                      {!loading && <span className="material-symbols-outlined">arrow_forward</span>}
                    </button>
                    <p className="text-[10px] text-gray-400 text-center">We'll send a login link to your inbox. No passwords needed.</p>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* --- SIGN IN MODAL --- */}
        {showSignIn && (
          <div className="fixed inset-0 z-50 overflow-y-auto font-display">
            <div className="absolute inset-0 z-0">
              <div className="w-full h-full bg-cover bg-center" style={{ backgroundImage: `url('https://images.unsplash.com/photo-1587174486073-ae5e5cff23aa?q=80&w=2070&auto=format&fit=crop')` }}></div>
              <div className="absolute inset-0 bg-black/40 backdrop-blur-md z-10"></div>
            </div>
            <div className="relative z-20 flex items-center justify-center h-full w-full px-4 sm:px-6">
              <div className="w-full max-w-[520px] bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col animate-[fadeInUp_0.3s_ease-out]">
                {/* Header with Close Button */}
                <div className="px-8 pt-8 pb-4 flex items-center justify-between">
                  <span className="text-sm font-semibold text-[#1e4d2b] tracking-wide uppercase">Welcome Back</span>
                  <button onClick={() => setShowSignIn(false)} className="text-gray-400 hover:text-gray-600 transition-colors">
                    <span className="material-symbols-outlined">close</span>
                  </button>
                </div>

                {/* SIGN IN STEP 1: FORM */}
                {signInStep === 1 && (
                  <div className="px-8 pb-10 flex flex-col">
                    <div className="mb-8 text-center sm:text-left">
                      <h1 className="text-3xl font-bold text-[#111811] leading-tight mb-2">Sign In</h1>
                      <p className="text-gray-500 text-base">Enter your email to access your trips.</p>
                    </div>
                    <form onSubmit={handleSignIn} className="flex flex-col gap-6">
                      <label className="flex flex-col gap-2">
                        <span className="text-[#111811] text-base font-semibold">Email Address</span>
                        <div className="relative">
                          <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><span className="material-symbols-outlined text-gray-400">mail</span></div>
                          <input autoFocus className="block w-full pl-12 pr-4 py-4 rounded-xl border border-gray-200 bg-gray-50 text-[#111811] placeholder-gray-400 focus:border-[#1e4d2b] focus:ring-[#1e4d2b] focus:ring-1 transition-all duration-200 text-lg outline-none" placeholder="name@email.com" type="email" value={signInEmail} onChange={(e) => setSignInEmail(e.target.value)} required />
                        </div>
                      </label>
                      <button disabled={loading} className="group relative w-full flex justify-center py-4 px-4 border border-transparent text-lg font-bold rounded-xl text-white bg-[#1e4d2b] hover:bg-[#153820] focus:outline-none transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50" type="submit">
                        {loading ? 'Sending...' : 'Send Magic Link'}
                      </button>
                    </form>
                  </div>
                )}

                {/* SIGN IN STEP 2: CONFIRMATION */}
                {signInStep === 2 && (
                  <div className="px-8 pb-10 flex flex-col items-center text-center">
                    <div className="relative mb-8 mt-2">
                      <div className="w-24 h-24 bg-[#1e4d2b]/10 rounded-full flex items-center justify-center"><span className="material-symbols-outlined text-[#1e4d2b] text-[48px]">mail</span></div>
                      <div className="absolute -bottom-1 -right-1 bg-white rounded-full p-1.5 shadow-md"><div className="bg-[#D4AF37] rounded-full w-8 h-8 flex items-center justify-center"><span className="material-symbols-outlined text-white text-[18px]">flag</span></div></div>
                    </div>
                    <div className="mb-6">
                      <h1 className="text-3xl font-bold text-[#111811] leading-tight mb-4">Check your inbox!</h1>
                      <p className="text-gray-600 text-base leading-relaxed max-w-sm mx-auto">We've sent a secure login link to <strong>{signInEmail}</strong>.</p>
                    </div>
                    <button onClick={() => handleResend(signInEmail)} disabled={loading} className="w-full flex justify-center py-4 px-4 border border-gray-300 text-lg font-bold rounded-xl text-[#1e4d2b] hover:bg-gray-50 transition-all shadow-sm">
                      {loading ? 'Resending...' : 'Resend email'}
                    </button>
                    <button onClick={() => setSignInStep(1)} className="mt-4 text-sm font-medium text-gray-500 hover:text-[#1e4d2b] underline">Try different email</button>
                  </div>
                )}
                
                <div className="bg-gray-50 px-8 py-4 border-t border-gray-100 flex justify-center items-center">
                  <div className="flex items-center gap-2 text-[#D4AF37] opacity-80"><span className="material-symbols-outlined text-sm">golf_course</span><span className="text-xs font-semibold tracking-wider uppercase">GolfTripHQ</span></div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* --- CREATE TRIP CONFIRMATION MODAL --- */}
        {currentStep === 2 && (
          <div className="fixed inset-0 z-50 overflow-y-auto font-display">
             <div className="absolute inset-0 z-0">
               <div className="w-full h-full bg-cover bg-center" style={{ backgroundImage: `url('https://images.unsplash.com/photo-1587174486073-ae5e5cff23aa?q=80&w=2070&auto=format&fit=crop')` }}></div>
               <div className="absolute inset-0 bg-black/40 backdrop-blur-md z-10"></div>
             </div>
             <div className="relative z-20 flex items-center justify-center h-full w-full px-4 sm:px-6">
               <div className="w-full max-w-[520px] bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col animate-[fadeInUp_0.3s_ease-out]">
                 <div className="px-8 pt-8 pb-4">
                   <div className="flex items-center justify-between mb-3">
                     <span className="text-sm font-semibold text-[#1e4d2b] tracking-wide uppercase">Step 2 of 2</span>
                     <span className="text-sm text-gray-500 font-medium">Complete</span>
                   </div>
                   <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-[#D4AF37] w-full rounded-full"></div></div>
                 </div>
                 <div className="px-8 pb-10 flex flex-col items-center text-center">
                   <div className="relative mb-8 mt-2">
                     <div className="w-24 h-24 bg-[#1e4d2b]/10 rounded-full flex items-center justify-center"><span className="material-symbols-outlined text-[#1e4d2b] text-[48px]">mail</span></div>
                     <div className="absolute -bottom-1 -right-1 bg-white rounded-full p-1.5 shadow-md"><div className="bg-[#D4AF37] rounded-full w-8 h-8 flex items-center justify-center"><span className="material-symbols-outlined text-white text-[18px]">flag</span></div></div>
                   </div>
                   <div className="mb-6">
                     <h1 className="text-3xl font-bold text-[#111811] leading-tight mb-4">Check your inbox!</h1>
                     <p className="text-gray-600 text-base leading-relaxed max-w-sm mx-auto">We've sent a magic link to your email. Click the link to securely access your <span className="font-semibold text-[#1e4d2b]">"{location || 'Golf Trip'}"</span> trip.</p>
                   </div>
                   <button onClick={() => handleResend(email)} disabled={loading} className="w-full flex justify-center py-4 px-4 border border-gray-300 text-lg font-bold rounded-xl text-[#1e4d2b] hover:bg-gray-50 transition-all shadow-sm disabled:opacity-50">
                      {loading ? 'Resending...' : 'Resend email'}
                   </button>
                   <button onClick={() => handleEditEmail()} className="mt-4 text-sm font-medium text-gray-500 hover:text-[#1e4d2b] underline">Enter a different email</button>
                 </div>
                 <div className="bg-gray-50 px-8 py-4 border-t border-gray-100 flex justify-center items-center">
                   <div className="flex items-center gap-2 text-[#D4AF37] opacity-80"><span className="material-symbols-outlined text-sm">golf_course</span><span className="text-xs font-semibold tracking-wider uppercase">Premium Golf Trips</span></div>
                 </div>
               </div>
             </div>
           </div>
        )}

        {/* --- FEATURES & FOOTER --- */}
        <div className="w-full py-24 px-4 sm:px-10 bg-[#f9fbf9] relative overflow-hidden">
          <div className="absolute top-0 right-0 -translate-y-1/2 translate-x-1/4 w-96 h-96 bg-[#d4af37]/5 rounded-full blur-3xl"></div>
          <div className="absolute bottom-0 left-0 translate-y-1/2 -translate-x-1/4 w-96 h-96 bg-[#1a4d2e]/5 rounded-full blur-3xl"></div>
          <div className="max-w-7xl mx-auto flex flex-col gap-16 relative z-10">
            <div className="flex flex-col items-center text-center gap-4 max-w-3xl mx-auto">
              <h2 className="text-[#0d2818] text-3xl sm:text-4xl font-bold leading-tight tracking-tight">
                Everything you need to organize your trip
              </h2>
              <p className="text-gray-600 text-lg font-normal leading-relaxed">
                Add tee times, split expenses, and manage travel all in one place.
              </p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              <FeatureCard icon="schedule" title="Coordinate Tee Times" desc="Easily add rounds for your entire group and keep everyone on time." />
              <FeatureCard icon="payments" title="Split Expenses" desc="Track all expenses for the trip in one convenient place and easily calculate balances." />
              <FeatureCard icon="luggage" title="Manage Travel" desc="Save flights, hotels, and other travel details for your group." />
            </div>
          </div>
        </div>
      </main>

      <footer className="bg-white border-t border-gray-200 py-12 px-4 sm:px-10">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-8">
          <div className="flex flex-col gap-2">
            <div className="flex items-center gap-2 text-[#0d2818] font-bold text-xl">
              <span className="material-symbols-outlined text-[#d4af37]">sports_golf</span>
              <span>GolfTripHQ</span>
            </div>
            <p className="text-sm text-gray-500">© 2026 GolfTripHQ Inc. All rights reserved.</p>
          </div>
          <div className="flex items-center gap-8 text-sm font-medium text-gray-600">
            <a className="hover:text-[#1a4d2e] transition-colors cursor-pointer">About</a>
            <a className="hover:text-[#1a4d2e] transition-colors cursor-pointer">Contact</a>
          </div>
          <div className="flex gap-4">
          </div>
        </div>
      </footer>
    </div>
  )
}

function FeatureCard({ icon, title, desc }: { icon: string, title: string, desc: string }) {
  return (
    <div className="group flex flex-col gap-6 p-8 rounded-3xl bg-white border border-gray-100 shadow-xl shadow-gray-200/50 hover:-translate-y-1 transition-all duration-300">
      <div className="w-14 h-14 rounded-2xl bg-[#1a4d2e]/10 text-[#1a4d2e] flex items-center justify-center group-hover:scale-110 transition-transform">
        <span className="material-symbols-outlined text-3xl">{icon}</span>
      </div>
      <div className="flex flex-col gap-3">
        <h3 className="text-[#0d2818] text-xl font-bold">{title}</h3>
        <p className="text-gray-500 leading-relaxed">{desc}</p>
      </div>
    </div>
  )
}

function SocialIcon({ icon }: { icon: string }) {
  return (
    <a className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-[#1a4d2e] hover:text-white transition-all cursor-pointer">
      <span className="material-symbols-outlined text-lg">{icon}</span>
    </a>
  )
}
</file>

</files>
